<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniStartupBoard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Add Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup, 
      signOut, 
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDai51SRR7C5mFO4KlORs6qwHyPohyvsgg",
      authDomain: "unistartupboard.firebaseapp.com",
      projectId: "unistartupboard",
      storageBucket: "unistartupboard.firebasestorage.app",
      messagingSenderId: "361490758670",
      appId: "1:361490758670:web:7b6c730b759198949bd05f",
      measurementId: "G-YY7CQKH2WJ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Set initialization flag to prevent premature Firestore operations
    window.isInitializing = true;
    window.currentUser = null;
    
    // Expose Firestore pieces to the global scope for the Babel script
    window.firestoreDb = db;
    window.firestoreApi = { doc, setDoc, getDoc, collection, getDocs, addDoc };

    // Make Firebase available globally
    window.firebase = {
      auth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    };
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    // Access Firestore DB and API that were initialized in the module script
    const firestoreDb = window.firestoreDb;
    const { doc, setDoc, getDoc, collection, getDocs, addDoc } = window.firestoreApi || {};
    
    // Initialize empty arrays for data
    const initialUniversities = [];
    const initialPosts = [];
    const initialUsers = [];
    
    // Global variable for current users to avoid reference errors
    let currentUsers = [];

    // Random animal images for default avatars
    const defaultAvatars = [
      "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba", // Cat
      "https://images.unsplash.com/photo-1534361967620-2249b4a87a49", // Dog
      "https://images.unsplash.com/photo-1519338381761-c7523edc1f46", // Fox
      "https://images.unsplash.com/photo-1564349683136-77e08dba1ef7", // Panda
    ];

    // Get random avatar
    const getRandomAvatar = () => defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)];

    // Simple in-memory cache to avoid repeated geocoding lookups during a session
    const geocodeCache = new Map();
    async function geocodeUniversity(universityName, cityHint = "") {
      const key = `${universityName}|${cityHint}`.trim();
      if (geocodeCache.has(key)) return geocodeCache.get(key);
      try {
        const q = `${universityName} ${cityHint}`.trim();
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('geocode http ' + res.status);
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
          geocodeCache.set(key, coords);
          return coords;
        }
      } catch (err) {
        console.warn('Geocoding failed for', universityName, err);
      }
      return null;
    }

    // City inference fallback (used when a university record lacks `city`)
    const CITY_UNI_SETS = {
      'Pittsburgh': new Set([
        'University of Pittsburgh', 'Carnegie Mellon University', 'Duquesne University', 'Carlow University',
        'Point Park University', 'Chatham University', 'Community College of Allegheny County',
        'Robert Morris University', 'Seton Hill University', 'Saint Vincent College',
        'University of Pittsburgh at Greensburg', 'PennWest California',
        'Washington & Jefferson College', 'Waynesburg University', 'Slippery Rock University',
        'Indiana University of Pennsylvania'
      ]),
      'San Francisco': new Set([
        'Stanford University', 'University of California, Berkeley', 'San Francisco State University',
        'University of San Francisco'
      ]),
      'Boston': new Set([
        'Harvard University', 'Massachusetts Institute of Technology', 'Boston University',
        'Northeastern University'
      ]),
      'New York City': new Set([
        'Columbia University', 'New York University', 'Cornell Tech'
      ]),
      'Chicago': new Set([
        'University of Chicago', 'Northwestern University', 'University of Illinois Chicago',
        'Illinois Institute of Technology', 'Loyola University Chicago'
      ]),
      'Seattle': new Set([
        'University of Washington'
      ]),
      'Austin': new Set([
        'The University of Texas at Austin'
      ])
    };
    function inferCityByName(universityName) {
      for (const [city, set] of Object.entries(CITY_UNI_SETS)) {
        if (set.has(universityName)) return city;
      }
      return undefined;
    }

    // Normalize an input domain to its registrable root (simple heuristic):
    // - lowercases
    // - trims whitespace
    // - keeps the last two labels (e.g., "andrew.cmu.edu" -> "cmu.edu").
    // This is sufficient for our .edu domains and most common cases in the app.
    function normalizeDomain(input) {
      const raw = (input || '').toLowerCase().trim();
      const parts = raw.split('@');
      const domainOnly = parts.length > 1 ? parts[1] : parts[0];
      const labels = domainOnly.split('.').filter(Boolean);
      if (labels.length <= 2) return domainOnly;
      const root = labels.slice(-2).join('.');
      return root;
    }

    // Firestore helpers
    const saveToFirestore = async (collectionName, docId, data) => {
      try {
        await setDoc(doc(firestoreDb, collectionName, docId), data, { merge: true });
      } catch (error) {
        if (error.code === 'permission-denied') {
          console.warn('Permission denied saving to Firestore:', error.message);
          // Continue without saving - this is expected for unauthenticated users
        } else {
          console.error('Error saving to Firestore:', error);
        }
      }
    };

    const loadFromFirestore = async (collectionName, docId) => {
      try {
        const snap = await getDoc(doc(firestoreDb, collectionName, docId));
        return snap.exists() ? snap.data() : null;
      } catch (error) {
        if (error.code === 'permission-denied') {
          console.warn('Permission denied loading from Firestore:', error.message);
          // Return null for permission issues - this is expected for unauthenticated users
          return null;
        } else {
          console.error('Error loading from Firestore:', error);
          return null;
        }
      }
    };

    // Haversine formula for distance
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 3958.8; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Function to get university name from email domain
    function getUniversityFromDomain(emailDomain) {
      // Convert domain to university name (e.g., "harvard.edu" -> "Harvard University")
      const domain = emailDomain.split('.')[0];
      return domain.charAt(0).toUpperCase() + domain.slice(1) + " University";
    }

    // Function to get default coordinates for a university
    function getDefaultCoordinates() {
      // Default to Pittsburgh
      return { lat: 40.4406, lng: -79.9959 };
    }

    // Firestore save function for app data
    const saveToFirestoreApp = async (key, data) => {
      // Don't try to save if we're still initializing or if no user is authenticated
      if (window.isInitializing || !window.currentUser) {
        return;
      }
      
      try {
        await saveToFirestore('app', key, { data, updatedAt: new Date().toISOString() });
      } catch (error) {
        console.warn('Failed to save app data to Firestore:', error.message);
        // Continue without saving - this is expected for unauthenticated users
      }
    };

    function App() {
      const [user, setUser] = useState(null);
      const [posts, setPosts] = useState(initialPosts);
      const [users, setUsers] = useState(initialUsers);
      const [universities, setUniversities] = useState(initialUniversities);
      const [view, setView] = useState("board");
      const [verificationSent, setVerificationSent] = useState(false);
      const [selectedUserId, setSelectedUserId] = useState(null);
      const [feedMode, setFeedMode] = useState("global"); // default to global for signed-out users
      const [selectedCity, setSelectedCity] = useState("Boston");

      const [universityFilter, setUniversityFilter] = useState(null);
      const [distanceFilter, setDistanceFilter] = useState(50); // Default 50 miles
      const [domainIndex, setDomainIndex] = useState({});
      const [isLoading, setIsLoading] = useState(true);
      const [isInitializing, setIsInitializing] = useState(true);
      const [error, setError] = useState(null);
      const [actionNotice, setActionNotice] = useState("");

      const promptSignIn = (_message) => {
        setActionNotice('Sign in with .edu email to view');
        setView('signin');
        // Auto-clear after a short period
        try { setTimeout(() => setActionNotice(""), 3500); } catch(_) {}
      };

      // Known quick domain→name hints to short-circuit common cases
      // Base quick map. Will be expanded at runtime from data/university_domains.json
      let KNOWN_DOMAIN_MAP = {
        'cmu.edu': 'Carnegie Mellon University',
        'pitt.edu': 'University of Pittsburgh',
        'duq.edu': 'Duquesne University',
        'sfsu.edu': 'San Francisco State University',
        'usfca.edu': 'University of San Francisco',
        'stanford.edu': 'Stanford University',
        'berkeley.edu': 'University of California, Berkeley',
        'sjsu.edu': 'San Jose State University',
        'scu.edu': 'Santa Clara University',
        'cnu.edu': 'Christopher Newport University',
        'harvard.edu': 'Harvard University',
        'mit.edu': 'Massachusetts Institute of Technology',
        'bu.edu': 'Boston University',
        'northeastern.edu': 'Northeastern University'
      };

      // Expand KNOWN_DOMAIN_MAP from static JSON list (bundled) and cache the load
      let __knownDomainsLoadPromise = null;
      function ensureKnownDomainsLoaded() {
        if (__knownDomainsLoadPromise) return __knownDomainsLoadPromise;
        __knownDomainsLoadPromise = (async () => {
          const tryPaths = [
            'data/university_domains.json',
            '/CollegeApp/data/university_domains.json',
            '/data/university_domains.json',
            (function () {
              try {
                const base = (window.location.pathname || '').replace(/[^\/]+$/, '');
                return base + 'data/university_domains.json';
              } catch (_) { return null; }
            })()
          ].filter(Boolean);
          for (const p of tryPaths) {
            try {
              const res = await fetch(p, { cache: 'no-store' });
              if (res && res.ok) {
                const json = await res.json();
                if (json && typeof json === 'object') {
                  KNOWN_DOMAIN_MAP = { ...KNOWN_DOMAIN_MAP, ...json };
                  window.__KNOWN_DOMAIN_MAP = KNOWN_DOMAIN_MAP;
                  break;
                }
              }
            } catch (_) { /* try next */ }
          }
        })();
        return __knownDomainsLoadPromise;
      }

      // Canonical resolver by email domain
      const resolveUniversityByDomain = async (emailDomain, currentUniversities) => {
        await ensureKnownDomainsLoaded();
        const rawDomain = (emailDomain || '').toLowerCase().trim();
        const domain = normalizeDomain(emailDomain);
        // 1) Use already-known universities (keeps existing ids)
        let uni = currentUniversities.find(u => (u.emailDomain || '').toLowerCase() === domain);
        if (uni) return { uni, changed: false };
        // 1b) Quick map
        const quickName = KNOWN_DOMAIN_MAP[rawDomain] || KNOWN_DOMAIN_MAP[domain];
        if (quickName) {
          const existingByName = currentUniversities.find(u => (u.name || '') === quickName);
          if (existingByName) return { uni: existingByName, changed: false };
        }
        // 2) Use domain index (Firestore-seeded)
        let hit = domainIndex && domainIndex[domain];
        if (!hit) {
          try {
            const doc = await loadFromFirestore('app', 'domain_index');
            if (doc && doc.map) hit = doc.map[domain];
          } catch (error) {
            console.warn('Failed to load domain index from Firestore:', error);
          }
        }
        if (hit) {
          const canonical = {
            id: (Math.max(0, ...currentUniversities.map(u => u.id || 0)) + 1),
            name: hit.name,
            emailDomain: domain,
            lat: hit.lat ?? getDefaultCoordinates().lat,
            lng: hit.lng ?? getDefaultCoordinates().lng,
            city: hit.city || inferCityByName(hit.name)
          };
          return { uni: canonical, changed: true };
        }
        // 3) Fallback to inferred string
        const inferredName = getUniversityFromDomain(domain);
        const fallback = {
          id: (Math.max(0, ...currentUniversities.map(u => u.id || 0)) + 1),
          name: inferredName,
          emailDomain: domain,
          ...getDefaultCoordinates(),
          city: inferCityByName(inferredName)
        };
        return { uni: fallback, changed: true };
      };

      // Save data whenever it changes - but only if user is authenticated
      useEffect(() => {
        if (user) {
          saveToFirestoreApp('posts', posts);
        }
      }, [posts, user]);

      useEffect(() => {
        if (user) {
          saveToFirestoreApp('users', users);
        }
      }, [users, user]);

      useEffect(() => {
        if (user) {
          saveToFirestoreApp('universities', universities);
        }
      }, [universities, user]);

      useEffect(() => {
        (async () => { await ensureKnownDomainsLoaded(); })();
        // Preload domain map so first detection is accurate
        
        // Listen for auth state changes
        const unsubscribe = window.firebase.onAuthStateChanged(window.firebase.auth, async (firebaseUser) => {
          // Update global flags for Firestore operations
          window.currentUser = firebaseUser;
          window.isInitializing = false;
          
          if (firebaseUser) {
            const email = firebaseUser.email;
        const emailDomain = normalizeDomain(email);
            
            // Find or create university (allow override from sign-up selection)
            const emailDomainLower = (emailDomain || '').toLowerCase();
            let university = universities.find(u => (u.emailDomain || '').toLowerCase() === emailDomainLower);
            // If a university exists for this domain but name isn't canonical, fix it
            try {
              const domDoc = await loadFromFirestore('app', 'domain_index');
              const domMap = (domDoc && domDoc.map) ? domDoc.map : {};
              const hit = domMap && domMap[emailDomainLower];
              if (hit && university && university.name !== hit.name) {
                const renamed = { ...university, name: hit.name, lat: hit.lat ?? university.lat, lng: hit.lng ?? university.lng, city: hit.city || university.city };
                const updated = universities.map(u => u.id === university.id ? renamed : u);
                setUniversities(updated);
                university = renamed;
                try { await saveToFirestoreApp('universities', updated); } catch(_) {}
              }
            } catch (error) {
              console.warn('Failed to update universities with canonical names:', error);
            }
            if (!university && window.pendingUniversityChoice) {
              const chosen = window.pendingUniversityChoice;
              university = universities.find(u => u.name === chosen.name) || null;
              // If still not in list, add it with fallback coords
              if (!university) {
                // Try to geocode accurate coordinates
                const cityHint = inferCityByName(chosen.name) || '';
                // Try Firestore domain index first for accuracy
                let coords = null;
                try {
                  const domDoc = await loadFromFirestore('app', 'domain_index');
                  const map = (domDoc && domDoc.map) ? domDoc.map : {};
                  const dKey = (chosen.emailDomain || emailDomain || '').toLowerCase();
                  if (map && map[dKey]) {
                    coords = { lat: map[dKey].lat, lng: map[dKey].lng };
                  }
                } catch (error) {
                  console.warn('Failed to load domain index for coordinates:', error);
                }
                if (!coords) {
                  coords = await geocodeUniversity(chosen.name, cityHint);
                }
                if (!coords) coords = getDefaultCoordinates();
                const newUni = {
                  id: universities.length + 1,
                  name: chosen.name,
                  emailDomain: chosen.emailDomain || emailDomain,
                  lat: coords.lat,
                  lng: coords.lng,
                  city: cityHint
                };
                setUniversities(prev => [...prev, newUni]);
                university = newUni;
                // Persist updated universities to Firestore so future sessions skip geocoding
                try {
                  const toSave = [...universities, newUni];
                  await saveToFirestoreApp('universities', toSave);
                } catch (e) { console.warn('Failed to persist universities', e); }
              }
              // Clear the one-time hint
              window.pendingUniversityChoice = null;
            }
            if (!university) {
              // Canonicalize by domain from domain index first
              try {
                const domain = emailDomain.toLowerCase();
                const doc = await loadFromFirestore('app', 'domain_index');
                const map = (doc && doc.map) ? doc.map : {};
                const hit = map && map[domain];
                if (hit) {
                  const canon = {
                    id: universities.length + 1,
                    name: hit.name,
                    emailDomain: domain,
                    lat: hit.lat ?? getDefaultCoordinates().lat,
                    lng: hit.lng ?? getDefaultCoordinates().lng,
                    city: hit.city || inferCityByName(hit.name)
                  };
                  setUniversities(prev => [...prev, canon]);
                  university = canon;
                }
              } catch (error) {
                console.warn('Failed to canonicalize university by domain:', error);
              }
            }
            if (!university) {
              // Final fallback: derive from domain string
              const newUniversity = {
                id: universities.length + 1,
                name: getUniversityFromDomain(emailDomain),
                emailDomain: emailDomain,
                ...getDefaultCoordinates()
              };
              setUniversities(prev => [...prev, newUniversity]);
              university = newUniversity;
            }

            // Check if user already exists in our users array
            const existingUser = users.find(u => u.email === email);
            if (existingUser) {
              console.log("Found existing user:", existingUser);
              setUser(existingUser);
              setView("board");
            } else {
              // Create new user
              const newUser = { 
                id: users.length + 1, 
                email, 
                university: university.name, 
                lat: university.lat, 
                lng: university.lng,
                profile: null
              };
              console.log("Creating new user:", newUser);
              setUsers(prev => [...prev, newUser]);
              setUser(newUser);
              setView("profile");
            }
                  } else {
            // No user authenticated - public mode: Global board
            window.currentUser = null;
            setUser(null);
            setFeedMode('global');
            setView("board");
          }
        });

        return () => unsubscribe();
      }, [universities, users]); // Add dependencies to useEffect

      useEffect(() => {
        const fetchData = async () => {
          try {
            setIsLoading(true);
            setError(null);
            console.log('Fetching data from server...');
            const pittsburghUniversities = [
              { id: 1, name: "University of Pittsburgh", emailDomain: "pitt.edu", lat: 40.4440, lng: -79.9532, city: "Pittsburgh" },
            { id: 2, name: "Carnegie Mellon University", emailDomain: "cmu.edu", lat: 40.4433, lng: -79.9440, city: "Pittsburgh" },
            { id: 3, name: "Duquesne University", emailDomain: "duq.edu", lat: 40.4374, lng: -79.9909, city: "Pittsburgh" },
            { id: 4, name: "Carlow University", emailDomain: "carlow.edu", lat: 40.4397, lng: -79.9642, city: "Pittsburgh" },
            { id: 5, name: "Point Park University", emailDomain: "pointpark.edu", lat: 40.4387, lng: -80.0019, city: "Pittsburgh" },
            { id: 6, name: "Chatham University", emailDomain: "chatham.edu", lat: 40.4492, lng: -79.9258, city: "Pittsburgh" },
            { id: 7, name: "Community College of Allegheny County", emailDomain: "ccac.edu", lat: 40.4450, lng: -80.0180, city: "Pittsburgh" },
            { id: 8, name: "Robert Morris University", emailDomain: "rmu.edu", lat: 40.5206, lng: -80.2106, city: "Pittsburgh" },
            { id: 9, name: "Seton Hill University", emailDomain: "setonhill.edu", lat: 40.3092, lng: -79.5567, city: "Pittsburgh" },
            { id: 10, name: "Saint Vincent College", emailDomain: "stvincent.edu", lat: 40.2931, lng: -79.4036, city: "Pittsburgh" },
            { id: 11, name: "University of Pittsburgh at Greensburg", emailDomain: "greensburg.pitt.edu", lat: 40.2766, lng: -79.5316, city: "Pittsburgh" },
            { id: 12, name: "PennWest California", emailDomain: "calu.edu", lat: 40.0656, lng: -79.8853, city: "Pittsburgh" },
            { id: 13, name: "Washington & Jefferson College", emailDomain: "washjeff.edu", lat: 40.1709, lng: -80.2392, city: "Pittsburgh" },
            { id: 14, name: "Waynesburg University", emailDomain: "waynesburg.edu", lat: 39.9006, lng: -80.1867, city: "Pittsburgh" },
            { id: 15, name: "Slippery Rock University", emailDomain: "sru.edu", lat: 41.0639, lng: -80.0423, city: "Pittsburgh" },
            { id: 16, name: "Indiana University of Pennsylvania", emailDomain: "iup.edu", lat: 40.6175, lng: -79.1603, city: "Pittsburgh" }
          ];
          const sanFranciscoUniversities = [
            { name: "Stanford University", emailDomain: "stanford.edu", lat: 37.4275, lng: -122.1697, city: "San Francisco" },
            { name: "University of California, Berkeley", emailDomain: "berkeley.edu", lat: 37.8715, lng: -122.2730, city: "San Francisco" },
            { name: "San Francisco State University", emailDomain: "sfsu.edu", lat: 37.7219, lng: -122.4782, city: "San Francisco" },
            { name: "University of San Francisco", emailDomain: "usfca.edu", lat: 37.7750, lng: -122.4500, city: "San Francisco" },
            { name: "San Jose State University", emailDomain: "sjsu.edu", lat: 37.3352, lng: -121.8811, city: "San Francisco" },
            { name: "Santa Clara University", emailDomain: "scu.edu", lat: 37.3496, lng: -121.9390, city: "San Francisco" }
          ];
          const bostonUniversities = [
            { name: "Harvard University", emailDomain: "harvard.edu", lat: 42.3770, lng: -71.1167, city: "Boston" },
            { name: "Massachusetts Institute of Technology", emailDomain: "mit.edu", lat: 42.3601, lng: -71.0942, city: "Boston" },
            { name: "Boston University", emailDomain: "bu.edu", lat: 42.3505, lng: -71.1054, city: "Boston" },
            { name: "Northeastern University", emailDomain: "northeastern.edu", lat: 42.3398, lng: -71.0892, city: "Boston" }
          ];
          // Try to load from Firestore, but continue with fallback data if permissions fail
          let unisDoc, postsDoc, usersDoc, domainIdxDoc;
          try {
            [unisDoc, postsDoc, usersDoc, domainIdxDoc] = await Promise.all([
              loadFromFirestore('app', 'universities'),
              loadFromFirestore('app', 'posts'),
              loadFromFirestore('app', 'users'),
              loadFromFirestore('app', 'domain_index')
            ]);
          } catch (error) {
            console.warn('Failed to load data from Firestore, using fallback data:', error.message);
            unisDoc = postsDoc = usersDoc = domainIdxDoc = null;
          }
          const unis = unisDoc?.data || [];
          const ps = postsDoc?.data || [];
          const usrs = usersDoc?.data || [];
          let universitiesToSet = unis;
          console.log('Universities from server:', unis);
          if (unis.length === 0) {
            console.log('No universities found in Firestore, using comprehensive local data...');
            // Use our comprehensive local data that includes SJSU and Santa Clara University
            universitiesToSet = [
              ...pittsburghUniversities,
              ...sanFranciscoUniversities, 
              ...bostonUniversities,
              // Explicitly add our new schools to ensure they're included
              {
                id: 26,
                name: "San Jose State University",
                emailDomain: "sjsu.edu",
                lat: 37.3352,
                lng: -121.8811,
                city: "San Francisco"
              },
              {
                id: 27,
                name: "Santa Clara University",
                emailDomain: "scu.edu",
                lat: 37.3496,
                lng: -121.9390,
                city: "San Francisco"
              }
            ];
            await saveToFirestoreApp('universities', universitiesToSet);
            console.log('Saved comprehensive universities (including SJSU and SCU) to server');
          }
          // Ensure Pittsburgh entries have city metadata and add SF/Boston if missing
          let changed = false;
          const nameToUni = new Map(universitiesToSet.map(u => [u.name, u]));
          // Add missing city to Pittsburgh unis
          pittsburghUniversities.forEach(pu => {
            const existing = nameToUni.get(pu.name);
            if (existing && !existing.city) {
              existing.city = 'Pittsburgh';
              changed = true;
            }
          });
          // Helper to get next id
          const nextId = () => (Math.max(0, ...universitiesToSet.map(u => u.id || 0)) + 1);
          // Add SF and Boston unis if not present
          [...sanFranciscoUniversities, ...bostonUniversities].forEach(nu => {
            if (!nameToUni.has(nu.name)) {
              const newUni = { id: nextId(), ...nu };
              universitiesToSet.push(newUni);
              nameToUni.set(nu.name, newUni);
              changed = true;
            }
          });
          // Add NYC universities if not present
          const nycUniversities = [
            { name: 'Columbia University', emailDomain: 'columbia.edu', lat: 40.8075, lng: -73.9626, city: 'New York City' },
            { name: 'New York University', emailDomain: 'nyu.edu', lat: 40.7295, lng: -73.9965, city: 'New York City' },
            { name: 'Cornell Tech', emailDomain: 'tech.cornell.edu', lat: 40.7555, lng: -73.9533, city: 'New York City' }
          ];
          nycUniversities.forEach(nu => {
            if (!nameToUni.has(nu.name)) {
              const newUni = { id: nextId(), ...nu };
              universitiesToSet.push(newUni);
              nameToUni.set(nu.name, newUni);
              changed = true;
            }
          });
          // Add Chicago universities if not present
          const chicagoUniversities = [
            { name: 'University of Chicago', emailDomain: 'uchicago.edu', lat: 41.7886, lng: -87.5987, city: 'Chicago' },
            { name: 'Northwestern University', emailDomain: 'northwestern.edu', lat: 42.0565, lng: -87.6753, city: 'Chicago' },
            { name: 'University of Illinois Chicago', emailDomain: 'uic.edu', lat: 41.8708, lng: -87.6505, city: 'Chicago' },
            { name: 'Illinois Institute of Technology', emailDomain: 'iit.edu', lat: 41.8349, lng: -87.6270, city: 'Chicago' },
            { name: 'Loyola University Chicago', emailDomain: 'luc.edu', lat: 42.0016, lng: -87.6598, city: 'Chicago' }
          ];
          // Add Seattle and Austin universities if not present
          const seattleUniversities = [
            { name: 'University of Washington', emailDomain: 'uw.edu', lat: 47.6553, lng: -122.3035, city: 'Seattle' }
          ];
          const austinUniversities = [
            { name: 'The University of Texas at Austin', emailDomain: 'utexas.edu', lat: 30.2849, lng: -97.7341, city: 'Austin' }
          ];
          [...seattleUniversities, ...austinUniversities].forEach(nu => {
            if (!nameToUni.has(nu.name)) {
              const newUni = { id: nextId(), ...nu };
              universitiesToSet.push(newUni);
              nameToUni.set(nu.name, newUni);
              changed = true;
            }
          });
          chicagoUniversities.forEach(nu => {
            if (!nameToUni.has(nu.name)) {
              const newUni = { id: nextId(), ...nu };
              universitiesToSet.push(newUni);
              nameToUni.set(nu.name, newUni);
              changed = true;
            }
          });
          if (changed) {
            await saveToFirestoreApp('universities', universitiesToSet);
          }
          setUniversities(universitiesToSet);

          // Load domain index from Firestore and seed if missing
          if (domainIdxDoc && domainIdxDoc.map) {
            setDomainIndex(domainIdxDoc.map);
          } else {
            try {
              // Initialize with empty domain index if none exists
              setDomainIndex({});
              // Only try to save if user is authenticated
              if (window.currentUser) {
                await saveToFirestoreApp('domain_index', { map: {}, updatedAt: new Date().toISOString() });
              }
            } catch (e) { console.warn('Failed to seed domain index', e); }
          }

          // Helper to infer city if missing on a university
          const inferCity = (uniName) => {
            const fromState = universitiesToSet.find(u => u.name === uniName)?.city;
            if (fromState) return fromState;
            return inferCityByName(uniName);
          };

          let usersToSet = usrs;
          if (usrs.length === 0) {
            usersToSet = []; // generate dummy users based on universitiesToSet
            
            // Pittsburgh-themed user profiles
            const pittsburghUsers = [
              { firstName: "Sarah", lastName: "Chen", bio: "Computer Science major passionate about sustainable technology and smart city solutions.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Marcus", lastName: "Johnson", bio: "Engineering student focused on robotics and environmental conservation. Love exploring Pittsburgh's rivers.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Priya", lastName: "Patel", bio: "Public Health major working on healthcare accessibility solutions for rural communities.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "no" },
              { firstName: "Alex", lastName: "Rodriguez", bio: "Business student with a passion for local food systems and community development.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Emily", lastName: "Thompson", bio: "Environmental Science major working on renewable energy solutions for Pittsburgh neighborhoods.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "David", lastName: "Kim", bio: "Computer Engineering student developing IoT solutions for smart city infrastructure.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Rachel", lastName: "Williams", bio: "Psychology major creating mental health support platforms for college students.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Jordan", lastName: "Davis", bio: "Urban Planning student focused on sustainable transportation solutions for Pittsburgh's unique topography.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "no" },
              { firstName: "Aisha", lastName: "Hassan", bio: "Data Science major working on analytics solutions for small businesses in the Strip District.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Michael", lastName: "O'Connor", bio: "Mechanical Engineering student developing autonomous systems for environmental cleanup.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Sophia", lastName: "Garcia", bio: "Education major creating personalized learning platforms for K-12 students.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Tyler", lastName: "Brown", bio: "Chemical Engineering student working on smart brewing technology for craft beer enthusiasts.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Nina", lastName: "Anderson", bio: "Architecture student developing VR solutions for urban planning and architectural visualization.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "no" },
              { firstName: "Kevin", lastName: "Zhang", bio: "Blockchain developer working on credential verification systems for educational institutions.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Maya", lastName: "Singh", bio: "Community Development major creating platforms to strengthen neighborhood bonds in Pittsburgh.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Chris", lastName: "Wilson", bio: "AR/VR developer working on navigation and tourism solutions for Pittsburgh visitors.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" }
            ];
            
            universitiesToSet.forEach((uni, index) => {
              const userProfile = pittsburghUsers[index % pittsburghUsers.length];
              usersToSet.push({
                id: index + 1,
                email: `${userProfile.firstName.toLowerCase()}${userProfile.lastName.toLowerCase()}@${uni.emailDomain}`,
                university: uni.name,
                lat: uni.lat,
                lng: uni.lng,
                profile: {
                  firstName: userProfile.firstName,
                  lastName: userProfile.lastName,
                  bio: userProfile.bio,
                  picture: getRandomAvatar(),
                  graduationYear: userProfile.graduationYear,
                  hasIdea: userProfile.hasIdea,
                  isWorkingOnIdea: userProfile.isWorkingOnIdea,
                  social: {}
                }
              });
            });
            
            // Create additional users for CMU, Pitt, and Duquesne
            const additionalUsers = [];
            
            // CMU additional users (4 more to make 5 total)
            const cmuUsers = [
              { firstName: "Alex", lastName: "Chen", bio: "Computer Science major specializing in AI and machine learning. Passionate about educational technology and personalized learning systems.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Maya", lastName: "Patel", bio: "Robotics Engineering student focused on assistive technology and social robotics. Working on projects that help people with disabilities.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "David", lastName: "Kim", bio: "Cybersecurity major developing threat detection systems. Interested in protecting small businesses from cyber attacks.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Sarah", lastName: "Johnson", bio: "Environmental Engineering student working on sustainable campus initiatives. Focused on IoT and energy management systems.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "no" }
            ];
            
            // Pitt additional users (2 more to make 3 total)
            const pittUsers = [
              { firstName: "Michael", lastName: "Brown", bio: "Public Health major creating mental health support platforms for college students. Focused on accessible healthcare solutions.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Emily", lastName: "Davis", bio: "Business major working on startup incubation and innovation hubs. Passionate about connecting students with entrepreneurial opportunities.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "yes" }
            ];
            
            // Duquesne additional users (2 more to make 3 total)
            const duquesneUsers = [
              { firstName: "James", lastName: "Wilson", bio: "Law student developing legal technology solutions. Working on AI-powered legal research and document analysis tools.", graduationYear: "2025", hasIdea: "yes", isWorkingOnIdea: "yes" },
              { firstName: "Lisa", lastName: "Garcia", bio: "Business Ethics major creating AI systems for ethical decision-making in business. Focused on stakeholder impact analysis.", graduationYear: "2026", hasIdea: "yes", isWorkingOnIdea: "no" }
            ];
            
            // Add CMU users
            cmuUsers.forEach((userProfile, index) => {
              const cmuUni = universitiesToSet.find(u => u.name === "Carnegie Mellon University");
              additionalUsers.push({
                id: usersToSet.length + index + 1,
                email: `${userProfile.firstName.toLowerCase()}${userProfile.lastName.toLowerCase()}@${cmuUni.emailDomain}`,
                university: cmuUni.name,
                lat: cmuUni.lat,
                lng: cmuUni.lng,
                profile: {
                  firstName: userProfile.firstName,
                  lastName: userProfile.lastName,
                  bio: userProfile.bio,
                  picture: getRandomAvatar(),
                  graduationYear: userProfile.graduationYear,
                  hasIdea: userProfile.hasIdea,
                  isWorkingOnIdea: userProfile.isWorkingOnIdea,
                  social: {}
                }
              });
            });
            
            // Add Pitt users
            pittUsers.forEach((userProfile, index) => {
              const pittUni = universitiesToSet.find(u => u.name === "University of Pittsburgh");
              additionalUsers.push({
                id: usersToSet.length + cmuUsers.length + index + 1,
                email: `${userProfile.firstName.toLowerCase()}${userProfile.lastName.toLowerCase()}@${pittUni.emailDomain}`,
                university: pittUni.name,
                lat: pittUni.lat,
                lng: pittUni.lng,
                profile: {
                  firstName: userProfile.firstName,
                  lastName: userProfile.lastName,
                  bio: userProfile.bio,
                  picture: getRandomAvatar(),
                  graduationYear: userProfile.graduationYear,
                  hasIdea: userProfile.hasIdea,
                  isWorkingOnIdea: userProfile.isWorkingOnIdea,
                  social: {}
                }
              });
            });
            
            // Add Duquesne users
            duquesneUsers.forEach((userProfile, index) => {
              const duquesneUni = universitiesToSet.find(u => u.name === "Duquesne University");
              additionalUsers.push({
                id: usersToSet.length + cmuUsers.length + pittUsers.length + index + 1,
                email: `${userProfile.firstName.toLowerCase()}${userProfile.lastName.toLowerCase()}@${duquesneUni.emailDomain}`,
                university: duquesneUni.name,
                lat: duquesneUni.lat,
                lng: duquesneUni.lng,
                profile: {
                  firstName: userProfile.firstName,
                  lastName: userProfile.lastName,
                  bio: userProfile.bio,
                  picture: getRandomAvatar(),
                  graduationYear: userProfile.graduationYear,
                  hasIdea: userProfile.hasIdea,
                  isWorkingOnIdea: userProfile.isWorkingOnIdea,
                  social: {}
                }
              });
            });
            
            // Combine all users
            const allUsers = [...usersToSet, ...additionalUsers];
            await saveToFirestoreApp('users', allUsers);
            setUsers(allUsers);
            // Update currentUsers to include the additional users for post creation
            currentUsers = allUsers;
          } else {
            setUsers(usersToSet);
          }
          // Ensure users exist for newly added SF/Boston universities
          const ensureUserForUniversity = (uniName, emailDomain, firstName, lastName, bio, gradYear) => {
            const existingUser = usersToSet.find(u => u.university === uniName);
            if (existingUser) return existingUser;
            const newUser = {
              id: (Math.max(0, ...usersToSet.map(u => u.id || 0)) + 1),
              email: `${firstName.toLowerCase()}${lastName.toLowerCase()}@${emailDomain}`,
              university: uniName,
              lat: universitiesToSet.find(u => u.name === uniName)?.lat || getDefaultCoordinates().lat,
              lng: universitiesToSet.find(u => u.name === uniName)?.lng || getDefaultCoordinates().lng,
              profile: {
                firstName,
                lastName,
                bio,
                picture: getRandomAvatar(),
                graduationYear: gradYear,
                hasIdea: 'yes',
                isWorkingOnIdea: 'yes',
                social: {}
              }
            };
            usersToSet.push(newUser);
            return newUser;
          };
          // Align user coordinates with their university if mismatched
          let usersChanged = false;
          usersToSet.forEach(u => {
            const uni = universitiesToSet.find(x => x.name === u.university);
            if (uni && (u.lat !== uni.lat || u.lng !== uni.lng)) {
              u.lat = uni.lat;
              u.lng = uni.lng;
              usersChanged = true;
            }
          });
          // Create minimal users per SF/Boston uni if missing
          const sfUserSpecs = [
            { uni: 'Stanford University', emailDomain: 'stanford.edu', first: 'Lena', last: 'Zhao', bio: 'CS student exploring AI for social good.', year: '2026' },
            { uni: 'University of California, Berkeley', emailDomain: 'berkeley.edu', first: 'Diego', last: 'Martinez', bio: 'EECS student building open-source tools.', year: '2025' },
            { uni: 'San Francisco State University', emailDomain: 'sfsu.edu', first: 'Ava', last: 'Nguyen', bio: 'Design student interested in civic tech.', year: '2025' },
            { uni: 'University of San Francisco', emailDomain: 'usfca.edu', first: 'Noah', last: 'Williams', bio: 'Business student focused on impact startups.', year: '2026' },
            { uni: 'San Jose State University', emailDomain: 'sjsu.edu', first: 'Jessica', last: 'Wong', bio: 'Computer Engineering major working on smart home automation.', year: '2025' },
            { uni: 'Santa Clara University', emailDomain: 'scu.edu', first: 'Sophia', last: 'Garcia', bio: 'Environmental Science major working on sustainable agriculture.', year: '2025' }
          ];
          const bostonUserSpecs = [
            { uni: 'Harvard University', emailDomain: 'harvard.edu', first: 'Maya', last: 'Singh', bio: 'Bioengineering student working on diagnostics.', year: '2025' },
            { uni: 'Massachusetts Institute of Technology', emailDomain: 'mit.edu', first: 'Ethan', last: 'Chen', bio: 'Robotics engineer building urban mobility.', year: '2026' },
            { uni: 'Boston University', emailDomain: 'bu.edu', first: 'Sofia', last: 'Garcia', bio: 'Public health student focused on access.', year: '2025' },
            { uni: 'Northeastern University', emailDomain: 'northeastern.edu', first: 'Liam', last: 'OBrien', bio: 'Software engineer passionate about co-ops.', year: '2026' }
          ];
          const nycUserSpecs = [
            { uni: 'Columbia University', emailDomain: 'columbia.edu', first: 'Arjun', last: 'Mehta', bio: 'Data Science student exploring fintech and urban analytics.', year: '2026' },
            { uni: 'New York University', emailDomain: 'nyu.edu', first: 'Chloe', last: 'Rossi', bio: 'Interactive media student building creator tools.', year: '2025' },
            { uni: 'Cornell Tech', emailDomain: 'tech.cornell.edu', first: 'Dante', last: 'Rivera', bio: 'CS grad student focused on applied AI for cities.', year: '2026' }
          ];
          const chicagoUserSpecs = [
            { uni: 'University of Chicago', emailDomain: 'uchicago.edu', first: 'Lila', last: 'Stone', bio: 'Booth student exploring venture-backed fintech.', year: '2025' },
            { uni: 'Northwestern University', emailDomain: 'northwestern.edu', first: 'Omar', last: 'Hassan', bio: 'McCormick engineer prototyping consumer apps at The Garage.', year: '2026' },
            { uni: 'University of Illinois Chicago', emailDomain: 'uic.edu', first: 'Gianna', last: 'Russo', bio: 'UIC CS major focused on health AI and urban systems.', year: '2025' },
            { uni: 'Illinois Institute of Technology', emailDomain: 'iit.edu', first: 'Mateo', last: 'Silva', bio: 'IIT EE building embedded systems for hard tech.', year: '2026' },
            { uni: 'Loyola University Chicago', emailDomain: 'luc.edu', first: 'Nora', last: 'Alvarez', bio: 'Ethics-focused student building social impact ventures.', year: '2025' }
          ];
          const seattleUserSpecs = [
            { uni: 'University of Washington', emailDomain: 'uw.edu', first: 'Hannah', last: 'Park', bio: 'UW HCDE student building civic tech and data tools.', year: '2026' },
            { uni: 'University of Washington', emailDomain: 'uw.edu', first: 'Ravi', last: 'Narayan', bio: 'CSE student working on distributed systems and ML.', year: '2025' }
          ];
          const austinUserSpecs = [
            { uni: 'The University of Texas at Austin', emailDomain: 'utexas.edu', first: 'Kayla', last: 'Rodriguez', bio: 'UT Austin CS building AI infra and devtools.', year: '2026' },
            { uni: 'The University of Texas at Austin', emailDomain: 'utexas.edu', first: 'Zane', last: 'Howard', bio: 'Business + CS pursuing consumer apps at Austin startups.', year: '2025' }
          ];
          const createdCityUsers = [];
          [...sfUserSpecs, ...bostonUserSpecs, ...nycUserSpecs, ...chicagoUserSpecs, ...seattleUserSpecs, ...austinUserSpecs].forEach(spec => {
            const u = ensureUserForUniversity(spec.uni, spec.emailDomain, spec.first, spec.last, spec.bio, spec.year);
            if (u) createdCityUsers.push(u);
          });
          // Ensure at least 3 users per SF/Boston university for diverse authorship
          const ensureNUsersForUni = (uniName, emailDomain, baseNames, n) => {
            const existing = usersToSet.filter(u => u.university === uniName);
            let nextId = Math.max(0, ...usersToSet.map(u => u.id || 0)) + 1;
            for (let i = existing.length; i < n; i++) {
              const name = baseNames[i % baseNames.length];
              const first = name.first;
              const last = name.last;
              const newUser = {
                id: nextId++,
                email: `${first.toLowerCase()}${last.toLowerCase()}@${emailDomain}`,
                university: uniName,
                lat: universitiesToSet.find(u => u.name === uniName)?.lat || getDefaultCoordinates().lat,
                lng: universitiesToSet.find(u => u.name === uniName)?.lng || getDefaultCoordinates().lng,
                profile: {
                  firstName: first,
                  lastName: last,
                  bio: `${first} ${last} is a student at ${uniName} working on innovative projects.`,
                  picture: getRandomAvatar(),
                  graduationYear: `${2025 + ((i + 1) % 2)}`,
                  hasIdea: 'yes',
                  isWorkingOnIdea: 'yes',
                  social: {}
                }
              };
              usersToSet.push(newUser);
            }
          };
          // Names per university to generate authors if needed
          const nameBank = {
            'Stanford University': { domain: 'stanford.edu', names: [
              { first: 'Aarav', last: 'Shah' }, { first: 'Ivy', last: 'Nguyen' }, { first: 'Lena', last: 'Zhao' },
              { first: 'Noah', last: 'Park' }
            ]},
            'University of California, Berkeley': { domain: 'berkeley.edu', names: [
              { first: 'Diego', last: 'Martinez' }, { first: 'Ananya', last: 'Patel' }, { first: 'Maya', last: 'Singh' },
              { first: 'Kevin', last: 'Zhang' }
            ]},
            'San Francisco State University': { domain: 'sfsu.edu', names: [
              { first: 'Luis', last: 'Romero' }, { first: 'Mina', last: 'Park' }, { first: 'Priya', last: 'Patel' },
              { first: 'Alex', last: 'Chen' }
            ]},
            'University of San Francisco': { domain: 'usfca.edu', names: [
              { first: 'Tara', last: 'Singh' }, { first: 'Owen', last: 'Chen' }, { first: 'Noah', last: 'Williams' },
              { first: 'Ava', last: 'Nguyen' }
            ]},
            'San Jose State University': { domain: 'sjsu.edu', names: [
              { first: 'Jessica', last: 'Wong' }, { first: 'Carlos', last: 'Rodriguez' }, { first: 'Maya', last: 'Patel' },
              { first: 'Alex', last: 'Kim' }
            ]},
            'Santa Clara University': { domain: 'scu.edu', names: [
              { first: 'Sophia', last: 'Garcia' }, { first: 'Kevin', last: 'Chen' }, { first: 'Emma', last: 'Wilson' },
              { first: 'Ryan', last: 'Davis' }
            ]},
            'Harvard University': { domain: 'harvard.edu', names: [
              { first: 'Emily', last: 'Thompson' }, { first: 'Noah', last: 'Brooks' }, { first: 'Zoe', last: 'Li' },
              { first: 'Liam', last: 'OBrien' }
            ]},
            'Massachusetts Institute of Technology': { domain: 'mit.edu', names: [
              { first: 'David', last: 'Kim' }, { first: 'Eric', last: 'Zhao' }, { first: 'Sara', last: 'Ahmed' },
              { first: 'Hana', last: 'Lee' }
            ]},
            'Boston University': { domain: 'bu.edu', names: [
              { first: 'Rachel', last: 'Williams' }, { first: 'Ben', last: 'Cohen' }, { first: 'Hanna', last: 'Lee' },
              { first: 'Ethan', last: 'Chen' }
            ]},
            'Northeastern University': { domain: 'northeastern.edu', names: [
              { first: 'Jordan', last: 'Davis' }, { first: 'Mateo', last: 'Garcia' }, { first: 'Chloe', last: 'Park' },
              { first: 'Aisha', last: 'Hassan' }
            ]}
            ,
            'Columbia University': { domain: 'columbia.edu', names: [
              { first: 'Arjun', last: 'Mehta' }, { first: 'Mia', last: 'Goldberg' }, { first: 'Ethan', last: 'Levy' },
              { first: 'Sana', last: 'Qureshi' }
            ]},
            'New York University': { domain: 'nyu.edu', names: [
              { first: 'Chloe', last: 'Rossi' }, { first: 'Noah', last: 'Green' }, { first: 'Ava', last: 'Cohen' },
              { first: 'Leo', last: 'Santos' }
            ]},
            'Cornell Tech': { domain: 'tech.cornell.edu', names: [
              { first: 'Dante', last: 'Rivera' }, { first: 'Iris', last: 'Lin' }, { first: 'Tomas', last: 'Novak' },
              { first: 'Yara', last: 'Haddad' }
            ]},
            'University of Chicago': { domain: 'uchicago.edu', names: [
              { first: 'Lila', last: 'Stone' }, { first: 'Arman', last: 'Khan' }, { first: 'Julia', last: 'Ng' },
              { first: 'Kenji', last: 'Ito' }
            ]},
            'Northwestern University': { domain: 'northwestern.edu', names: [
              { first: 'Omar', last: 'Hassan' }, { first: 'Mina', last: 'Solomon' }, { first: 'Evan', last: 'Pierce' },
              { first: 'Grace', last: 'Huang' }
            ]},
            'University of Illinois Chicago': { domain: 'uic.edu', names: [
              { first: 'Gianna', last: 'Russo' }, { first: 'Diego', last: 'Lopez' }, { first: 'Samir', last: 'Patel' },
              { first: 'Helena', last: 'Popov' }
            ]},
            'Illinois Institute of Technology': { domain: 'iit.edu', names: [
              { first: 'Mateo', last: 'Silva' }, { first: 'Anil', last: 'Verma' }, { first: 'Jade', last: 'Kim' },
              { first: 'Victor', last: 'Nguyen' }
            ]},
            'Loyola University Chicago': { domain: 'luc.edu', names: [
              { first: 'Nora', last: 'Alvarez' }, { first: 'Elena', last: 'Marin' }, { first: 'Jonah', last: 'Reed' },
              { first: 'Priya', last: 'Rao' }
            ]},
            'University of Washington': { domain: 'uw.edu', names: [
              { first: 'Hannah', last: 'Park' }, { first: 'Ravi', last: 'Narayan' }, { first: 'Selina', last: 'Chow' },
              { first: 'Marco', last: 'Delgado' }
            ]},
            'The University of Texas at Austin': { domain: 'utexas.edu', names: [
              { first: 'Kayla', last: 'Rodriguez' }, { first: 'Zane', last: 'Howard' }, { first: 'Priyanka', last: 'Ghosh' },
              { first: 'Jared', last: 'Ng' }
            ]}
          };
          Object.entries(nameBank).forEach(([uniName, info]) => {
            ensureNUsersForUni(uniName, info.domain, info.names, 3);
          });
          if (createdCityUsers.length > 0 || usersChanged) {
            await saveToFirestoreApp('users', usersToSet);
            setUsers(usersToSet);
          }

          let postsToSet = ps;
          if (ps.length === 0) {
            postsToSet = [];
            // Always use the users loaded into state for post generation
            currentUsers = usersToSet;
            // Pittsburgh startup ideas with realistic names and descriptions
            const pittsburghProjects = [
              // Carnegie Mellon Projects (5)
              {
                title: "CMU AI Tutor",
                summary: "Personalized AI tutoring system that adapts to individual learning styles and provides real-time feedback. Uses natural language processing to understand student questions and generate customized explanations.",
                lookingFor: "AI/ML engineers, educational psychologists, and full-stack developers. Experience with natural language processing and educational technology preferred.",
                category: "Education",
                stage: "development",
                projectLink: "https://cmuaitutor.com"
              },
              {
                title: "Robotics for Good",
                summary: "Social robotics platform designed to assist elderly and disabled individuals with daily tasks. Combines computer vision, natural language processing, and mechanical engineering for accessible automation.",
                lookingFor: "Robotics engineers, computer vision specialists, and healthcare professionals. Experience with assistive technology and human-robot interaction.",
                category: "Health",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "Cybersecurity Sentinel",
                summary: "Advanced threat detection system using machine learning to identify and prevent cyber attacks in real-time. Designed for small to medium businesses with limited IT resources.",
                lookingFor: "Cybersecurity experts, machine learning engineers, and backend developers. Experience with network security and threat intelligence.",
                category: "Tech",
                stage: "development",
                projectLink: "https://cybersentinel.cmu.edu"
              },
              {
                title: "Sustainable Campus",
                summary: "IoT-based energy management system for university campuses. Monitors and optimizes energy usage across buildings while providing data-driven insights for sustainability initiatives.",
                lookingFor: "IoT engineers, data scientists, and sustainability experts. Experience with building management systems and renewable energy.",
                category: "Sustainability",
                stage: "idea",
                projectLink: ""
              },
              {
                title: "Digital Art Marketplace",
                summary: "Blockchain-powered platform for digital artists to sell and authenticate their work. Uses smart contracts to ensure fair compensation and provenance tracking.",
                lookingFor: "Blockchain developers, UX designers, and art market experts. Experience with NFT technology and digital art platforms.",
                category: "Tech",
                stage: "planning",
                projectLink: ""
              },
              // University of Pittsburgh Projects (3)
              {
                title: "Pitt Health Connect",
                summary: "Telemedicine platform specifically designed for university students, connecting them with mental health professionals and peer support networks. Includes anonymous chat and crisis intervention features.",
                lookingFor: "Healthcare professionals, mobile app developers, and psychologists. Experience with mental health apps and HIPAA compliance.",
                category: "Health",
                stage: "development",
                projectLink: "https://pitthealthconnect.com"
              },
              {
                title: "Oakland Innovation Hub",
                summary: "Co-working space and startup incubator for Pitt students and alumni. Provides mentorship, funding connections, and access to university resources and research facilities.",
                lookingFor: "Business mentors, investors, and community organizers. Experience with startup ecosystems and university partnerships.",
                category: "Social Impact",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "Pitt Research Exchange",
                summary: "Platform connecting Pitt researchers with industry partners and investors. Facilitates technology transfer and commercialization of university research projects.",
                lookingFor: "Business development specialists, legal experts, and research administrators. Experience with technology transfer and intellectual property.",
                category: "Tech",
                stage: "idea",
                projectLink: ""
              },
              // Duquesne University Projects (3)
              {
                title: "Duquesne Legal Tech",
                summary: "AI-powered legal research and document analysis platform. Helps law students and legal professionals quickly find relevant case law and generate legal documents.",
                lookingFor: "Legal professionals, AI engineers, and law students. Experience with legal research and natural language processing.",
                category: "Tech",
                stage: "development",
                projectLink: "https://duquesnelegaltech.com"
              },
              {
                title: "Business Ethics AI",
                summary: "AI system that helps businesses make ethical decisions by analyzing potential impacts on stakeholders. Uses machine learning to evaluate business decisions against ethical frameworks.",
                lookingFor: "Ethics experts, AI engineers, and business analysts. Experience with ethical decision-making frameworks and machine learning.",
                category: "Social Impact",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "Pharmacy Innovation Lab",
                summary: "Digital platform for pharmaceutical research and development. Connects pharmacy students with pharmaceutical companies for collaborative research projects.",
                lookingFor: "Pharmacy professionals, software developers, and research coordinators. Experience with pharmaceutical research and clinical trials.",
                category: "Health",
                stage: "idea",
                projectLink: ""
              },
              // Additional Pittsburgh Projects
              {
                title: "Steel City Smart Grid",
                summary: "Developing an AI-powered energy management system for Pittsburgh's aging infrastructure. Using machine learning to optimize power distribution and reduce energy waste in residential and commercial buildings across the city.",
                lookingFor: "Electrical engineers, data scientists, and urban planning experts. Experience with IoT sensors and renewable energy systems preferred.",
                category: "Sustainability",
                stage: "development",
                projectLink: "https://steelcitysmartgrid.com"
              },
              {
                title: "Pittsburgh Food Hub",
                summary: "A digital platform connecting local farmers with restaurants and consumers in the Pittsburgh area. Features include real-time inventory tracking, delivery scheduling, and sustainable packaging solutions.",
                lookingFor: "Full-stack developers, UX designers, and business development specialists. Knowledge of supply chain logistics is a plus.",
                category: "Social Impact",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "MedTech Pittsburgh",
                summary: "Revolutionary telemedicine platform specifically designed for elderly care in rural Pennsylvania. Combines AI diagnostics with human oversight to provide accessible healthcare solutions.",
                lookingFor: "Healthcare professionals, software engineers, and regulatory compliance experts. Experience with HIPAA and medical device regulations required.",
                category: "Health",
                stage: "idea",
                projectLink: ""
              },
              {
                title: "Riverside Robotics",
                summary: "Autonomous cleaning robots for Pittsburgh's three rivers. Using computer vision and environmental sensors to collect floating debris while monitoring water quality in real-time.",
                lookingFor: "Robotics engineers, environmental scientists, and mechanical engineers. Experience with autonomous systems and water quality monitoring preferred.",
                category: "Tech",
                stage: "development",
                projectLink: "https://riversiderobotics.pitt.edu"
              },
              {
                title: "Oakland EdTech",
                summary: "Personalized learning platform for K-12 students in the Pittsburgh Public Schools district. Uses adaptive algorithms to create custom curriculum paths based on individual learning styles.",
                lookingFor: "Educational psychologists, software developers, and curriculum designers. Experience with educational technology and student assessment systems.",
                category: "Education",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "Strip District Analytics",
                summary: "Data analytics platform for small businesses in Pittsburgh's historic Strip District. Provides insights on customer behavior, inventory optimization, and market trends to help local businesses compete with larger retailers.",
                lookingFor: "Data analysts, business consultants, and marketing specialists. Experience with retail analytics and small business operations.",
                category: "Finance",
                stage: "idea",
                projectLink: ""
              },
              {
                title: "Squirrel Hill Social",
                summary: "Community engagement app for Pittsburgh neighborhoods. Features include local event coordination, neighborhood watch integration, and community resource sharing to strengthen neighborhood bonds.",
                lookingFor: "Community organizers, mobile app developers, and social workers. Experience with community building and civic technology preferred.",
                category: "Social Impact",
                stage: "development",
                projectLink: "https://squirrelhillsocial.org"
              },
              {
                title: "Mount Washington Mobility",
                summary: "Electric bike sharing and charging network for Pittsburgh's hilly terrain. Includes smart routing algorithms that consider elevation changes and battery optimization for the city's unique topography.",
                lookingFor: "Transportation engineers, electrical engineers, and urban mobility experts. Experience with electric vehicles and smart city infrastructure.",
                category: "Sustainability",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "Carnegie Crypto",
                summary: "Blockchain-based credential verification system for educational institutions. Allows students to securely share verified academic achievements with employers and other institutions.",
                lookingFor: "Blockchain developers, cybersecurity experts, and higher education administrators. Experience with digital credentials and academic verification systems.",
                category: "Tech",
                stage: "idea",
                projectLink: ""
              },
              {
                title: "Bloomfield BrewTech",
                summary: "Smart brewing system for craft beer enthusiasts. Uses IoT sensors and machine learning to optimize brewing conditions and create consistent, high-quality homebrew.",
                lookingFor: "Chemical engineers, IoT developers, and craft brewing experts. Experience with fermentation processes and sensor technology.",
                category: "Tech",
                stage: "development",
                projectLink: "https://bloomfieldbrewtech.com"
              },
              {
                title: "Lawrenceville Labs",
                summary: "Virtual reality platform for architectural visualization and urban planning. Allows stakeholders to experience proposed developments in immersive 3D before construction begins.",
                lookingFor: "VR developers, architects, and urban planners. Experience with 3D modeling and real estate development preferred.",
                category: "Tech",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "Shadyside Health",
                summary: "Mental health support platform connecting college students with peer counselors and professional therapists. Includes anonymous chat features and crisis intervention protocols.",
                lookingFor: "Mental health professionals, psychologists, and software developers. Experience with mental health apps and crisis intervention training.",
                category: "Health",
                stage: "development",
                projectLink: "https://shadysidehealth.org"
              },
              {
                title: "Point Breeze Energy",
                summary: "Community solar energy cooperative for Pittsburgh neighborhoods. Enables residents to invest in and benefit from local renewable energy projects.",
                lookingFor: "Energy policy experts, financial analysts, and community organizers. Experience with renewable energy projects and cooperative business models.",
                category: "Sustainability",
                stage: "idea",
                projectLink: ""
              },
              {
                title: "East Liberty Innovation",
                summary: "Startup incubator and co-working space focused on minority-owned businesses in Pittsburgh. Provides mentorship, funding connections, and business development resources.",
                lookingFor: "Business mentors, investors, and community development specialists. Experience with startup ecosystems and minority business development.",
                category: "Social Impact",
                stage: "planning",
                projectLink: ""
              },
              {
                title: "North Shore Navigation",
                summary: "Augmented reality app for Pittsburgh tourists and new residents. Provides historical context, restaurant recommendations, and navigation assistance using AR overlays.",
                lookingFor: "AR developers, historians, and UX designers. Experience with location-based services and Pittsburgh history preferred.",
                category: "Tech",
                stage: "development",
                projectLink: "https://northshorenav.com"
              },
              {
                title: "South Side Sustainability",
                summary: "Zero-waste delivery service for Pittsburgh restaurants and consumers. Uses reusable containers and electric vehicles to eliminate single-use packaging.",
                lookingFor: "Logistics experts, environmental scientists, and restaurant industry professionals. Experience with sustainable packaging and delivery systems.",
                category: "Sustainability",
                stage: "idea",
                projectLink: ""
              }
            ];

            // Helper: get N unique users for a university
            function getNUsersForUniversity(university, n) {
              const users = currentUsers.filter(u => u.university === university);
              if (users.length === 0) return [];
              // Return unique users up to the available count
              return users.slice(0, n);
            }

            let postId = 1;
            // CMU: 5 posts (we have 5 unique users)
            const cmuUsers = getNUsersForUniversity("Carnegie Mellon University", 5);
            if (cmuUsers.length >= 5) {
              for (let i = 0; i < 5; i++) {
                const user = cmuUsers[i];
                const project = pittsburghProjects[i];
                postsToSet.push({
                  id: postId++,
                  userId: user.id,
                  university: user.university,
                  title: project.title,
                  summary: project.summary,
                  lookingFor: project.lookingFor,
                  category: project.category,
                  projectLink: project.projectLink,
                  stage: project.stage,
                  createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0],
                  comments: []
                });
              }
            }
            // Pitt: 3 posts (we have 3 unique users)
            const pittUsers = getNUsersForUniversity("University of Pittsburgh", 3);
            if (pittUsers.length >= 3) {
              for (let i = 0; i < 3; i++) {
                const user = pittUsers[i];
                const project = pittsburghProjects[5 + i];
                postsToSet.push({
                  id: postId++,
                  userId: user.id,
                  university: user.university,
                  title: project.title,
                  summary: project.summary,
                  lookingFor: project.lookingFor,
                  category: project.category,
                  projectLink: project.projectLink,
                  stage: project.stage,
                  createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0],
                  comments: []
                });
              }
            }
            // Duquesne: 3 posts (we have 3 unique users)
            const duqUsers = getNUsersForUniversity("Duquesne University", 3);
            if (duqUsers.length >= 3) {
              for (let i = 0; i < 3; i++) {
                const user = duqUsers[i];
                const project = pittsburghProjects[8 + i];
                postsToSet.push({
                  id: postId++,
                  userId: user.id,
                  university: user.university,
                  title: project.title,
                  summary: project.summary,
                  lookingFor: project.lookingFor,
                  category: project.category,
                  projectLink: project.projectLink,
                  stage: project.stage,
                  createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0],
                  comments: []
                });
              }
            }
            // All other universities: 1 post each (each gets a unique user)
            const usedUniversities = ["Carnegie Mellon University", "University of Pittsburgh", "Duquesne University"];
            let extraProjectIdx = 11;
            universitiesToSet.forEach(uni => {
              if (!usedUniversities.includes(uni.name)) {
                const users = currentUsers.filter(u => u.university === uni.name);
                if (users.length > 0 && pittsburghProjects[extraProjectIdx]) {
                  const user = users[0]; // Use the first available user
                  const project = pittsburghProjects[extraProjectIdx];
                  postsToSet.push({
                    id: postId++,
                    userId: user.id,
                    university: user.university,
                    title: project.title,
                    summary: project.summary,
                    lookingFor: project.lookingFor,
                    category: project.category,
                    projectLink: project.projectLink,
                    stage: project.stage,
                    createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0],
                    comments: []
                  });
                  extraProjectIdx++;
                }
              }
            });
            await saveToFirestoreApp('posts', postsToSet);
          }
          // Seed posts for SF/Boston ensuring at least 3 per university
          // Seed Chicago posts: 3 per listed Chicago university, unique users
          const chicagoProjects = [
            // University of Chicago (3 projects)
            { title: 'Booth Venture Capital Analytics', summary: 'AI-powered platform analyzing startup metrics and market trends for early-stage VCs. Built by Booth MBAs with backgrounds in finance and machine learning.', lookingFor: 'Data scientists, financial analysts, full-stack developers', category: 'Finance', stage: 'development', projectLink: '' },
            { title: 'Hyde Park Health Exchange', summary: 'Connecting underserved South Side communities with healthcare resources. Platform matches patients with local clinics, volunteer doctors, and social services.', lookingFor: 'Healthcare coordinators, mobile developers, community organizers', category: 'Health', stage: 'planning', projectLink: '' },
            { title: 'Quantum Computing Education', summary: 'Interactive learning platform making quantum computing accessible to undergraduates. Features visualizations, simulations, and hands-on coding exercises.', lookingFor: 'Physics PhDs, frontend developers, educational content creators', category: 'Education', stage: 'idea', projectLink: '' },
            
            // Northwestern (3 projects)
            { title: 'Medill News Integrity AI', summary: 'Machine learning tools to detect deepfakes and verify news sources. Developed by Medill journalism students partnering with CS researchers.', lookingFor: 'ML engineers, journalists, security researchers', category: 'Tech', stage: 'development', projectLink: '' },
            { title: 'Garage Innovation Marketplace', summary: 'Platform connecting Northwestern student entrepreneurs with mentors, investors, and corporate partners. Built from The Garage incubator community.', lookingFor: 'Product managers, business development, full-stack developers', category: 'Tech', stage: 'planning', projectLink: '' },
            { title: 'Evanston Sustainability Hub', summary: 'Community-driven platform for tracking and reducing carbon footprints. Features local business partnerships and gamified sustainability challenges.', lookingFor: 'Environmental scientists, UX designers, backend developers', category: 'Sustainability', stage: 'development', projectLink: '' },
            
            // University of Illinois Chicago (3 projects)
            { title: 'Urban Health Data Commons', summary: 'Open platform aggregating public health data for Chicago neighborhoods. Enables researchers to identify health disparities and intervention opportunities.', lookingFor: 'Data engineers, epidemiologists, visualization specialists', category: 'Health', stage: 'planning', projectLink: '' },
            { title: 'Pilsen Arts Collective Platform', summary: 'Digital marketplace for local Chicago artists to sell work and connect with galleries. Includes virtual exhibition spaces and community event coordination.', lookingFor: 'Web developers, art curators, marketing specialists', category: 'Social Impact', stage: 'idea', projectLink: '' },
            { title: 'Smart Transit Chicago', summary: 'Real-time CTA optimization using crowdsourced data and predictive analytics. Helps commuters find fastest routes and avoid delays.', lookingFor: 'Mobile developers, data scientists, urban planners', category: 'Tech', stage: 'development', projectLink: '' },
            
            // Illinois Institute of Technology (3 projects)
            { title: 'Industrial IoT Monitoring System', summary: 'Sensor network for predictive maintenance in manufacturing facilities. Uses ML to predict equipment failures before they occur.', lookingFor: 'Embedded systems engineers, industrial engineers, ML specialists', category: 'Tech', stage: 'development', projectLink: '' },
            { title: 'Bronzeville Tech Training', summary: 'Coding bootcamp and career placement program for underrepresented communities on Chicago South Side. Partners with local tech companies.', lookingFor: 'Software instructors, career counselors, nonprofit managers', category: 'Education', stage: 'planning', projectLink: '' },
            { title: 'Chicago Architecture AR', summary: 'Augmented reality app showcasing Chicago architectural history. Users point phones at buildings to see historical photos and architect information.', lookingFor: 'AR developers, historians, 3D modelers', category: 'Tech', stage: 'idea', projectLink: '' },
            
            // Loyola University Chicago (3 projects)
            { title: 'Jesuit Social Justice Network', summary: 'Platform connecting faith-based organizations working on social justice initiatives. Facilitates resource sharing and collaborative advocacy campaigns.', lookingFor: 'Nonprofit coordinators, web developers, policy advocates', category: 'Social Impact', stage: 'development', projectLink: '' },
            { title: 'Rogers Park Community Kitchen', summary: 'Food insecurity platform matching surplus restaurant food with local families. Includes volunteer coordination and nutrition education resources.', lookingFor: 'Logistics coordinators, mobile developers, nutritionists', category: 'Social Impact', stage: 'planning', projectLink: '' },
            { title: 'Ethics in AI Consulting', summary: 'Consulting service helping companies implement ethical AI practices. Provides frameworks for bias detection and responsible ML deployment.', lookingFor: 'AI ethicists, consultants, technical writers', category: 'Tech', stage: 'idea', projectLink: '' }
          ];
          const chicagoNames = [
            'University of Chicago', 'Northwestern University', 'University of Illinois Chicago',
            'Illinois Institute of Technology', 'Loyola University Chicago'
          ];
          chicagoNames.forEach((uniName, idx) => {
            // ensure 3 posts per uni - each university gets its own unique 3 projects
            const need = 3 - postsToSet.filter(p => p.university === uniName).length;
            for (let i = 0; i < need; i++) {
              const authors = usersToSet.filter(u => u.university === uniName);
              if (authors.length === 0) break;
              const author = authors[i % authors.length];
              // Each university gets 3 consecutive unique projects: idx*3, idx*3+1, idx*3+2
              const projectIdx = (idx * 3) + i;
              const project = chicagoProjects[projectIdx];
              if (!project) break; // Safety check
              postsToSet.push({
                id: (Math.max(0, ...postsToSet.map(p => p.id || 0)) + 1),
                userId: author.id,
                university: uniName,
                title: project.title,
                summary: project.summary,
                lookingFor: project.lookingFor,
                category: project.category,
                projectLink: project.projectLink,
                stage: project.stage,
                createdAt: new Date().toISOString().split('T')[0],
                comments: []
              });
            }
          });
          // Seed NYC posts: 3 per NYC university, unique users
          const nycProjects = [
            // Columbia University (3 projects)
            { title: 'Morningside Microfinance', summary: 'Digital lending platform providing small loans to underbanked communities in Upper Manhattan. Uses alternative credit scoring based on rent and utility payments.', lookingFor: 'Backend engineers, financial analysts, community liaisons', category: 'Finance', stage: 'development', projectLink: '' },
            { title: 'Columbia Climate Tech', summary: 'Carbon capture technology spinout from Earth Institute research. Developing modular systems for urban buildings to reduce atmospheric CO2.', lookingFor: 'Chemical engineers, climate scientists, business development', category: 'Sustainability', stage: 'planning', projectLink: '' },
            { title: 'Harlem Health Access', summary: 'Telemedicine platform connecting Columbia medical students with Harlem residents. Provides free consultations and specialist referrals for underserved populations.', lookingFor: 'Medical students, mobile developers, healthcare coordinators', category: 'Health', stage: 'development', projectLink: '' },
            
            // NYU (3 projects)
            { title: 'Washington Square Music Collective', summary: 'Blockchain-based platform for independent musicians to distribute music and receive fair compensation. Built by Tisch and Stern students.', lookingFor: 'Smart contract developers, music producers, UX designers', category: 'Tech', stage: 'planning', projectLink: '' },
            { title: 'ITP Interactive Installations', summary: 'Platform connecting interactive artists with galleries and public spaces. Features portfolio hosting, exhibition management, and hardware rental marketplace.', lookingFor: 'Full-stack developers, artists, gallery coordinators', category: 'Tech', stage: 'idea', projectLink: '' },
            { title: 'NYU Global Health Innovation', summary: 'Low-cost diagnostic devices for resource-limited settings. Engineering students partnering with global health researchers to develop portable medical equipment.', lookingFor: 'Biomedical engineers, global health experts, supply chain specialists', category: 'Health', stage: 'development', projectLink: '' },
            
            // Cornell Tech (3 projects)
            { title: 'Roosevelt Island Smart Grid', summary: 'IoT sensor network optimizing energy distribution for Cornell Tech campus. Piloting vehicle-to-grid integration with electric buses and renewable energy.', lookingFor: 'Electrical engineers, IoT specialists, data scientists', category: 'Sustainability', stage: 'development', projectLink: '' },
            { title: 'NYC Transit Optimization AI', summary: 'Machine learning platform predicting subway delays and suggesting optimal routes. Integrates MTA data with weather, events, and crowdsourced information.', lookingFor: 'ML engineers, mobile developers, urban planners', category: 'Tech', stage: 'planning', projectLink: '' },
            { title: 'Startup Studio Accelerator', summary: 'Venture studio model connecting Cornell Tech students with serial entrepreneurs. Provides pre-seed funding, technical resources, and mentorship for rapid prototyping.', lookingFor: 'Product managers, investors, technical leads', category: 'Finance', stage: 'idea', projectLink: '' }
          ];
          const nycNames = ['Columbia University', 'New York University', 'Cornell Tech'];
          nycNames.forEach((uniName, idx) => {
            const need = 3 - postsToSet.filter(p => p.university === uniName).length;
            for (let i = 0; i < need; i++) {
              const authors = usersToSet.filter(u => u.university === uniName);
              if (authors.length === 0) break;
              const author = authors[i % authors.length];
              // Each university gets 3 consecutive unique projects: idx*3, idx*3+1, idx*3+2
              const projectIdx = (idx * 3) + i;
              const project = nycProjects[projectIdx];
              if (!project) break; // Safety check
              postsToSet.push({
                id: (Math.max(0, ...postsToSet.map(p => p.id || 0)) + 1),
                userId: author.id,
                university: uniName,
                title: project.title,
                summary: project.summary,
                lookingFor: project.lookingFor,
                category: project.category,
                projectLink: project.projectLink,
                stage: project.stage,
                createdAt: new Date().toISOString().split('T')[0],
                comments: []
              });
            }
          });
          // Seed Seattle: UW with 5 posts
          const uwProjects = [
            { title: 'Seattle Civic Data', summary: 'Open data tools from HCDE and CSE students for city services.', lookingFor: 'Frontend, PM', category: 'Civic Tech', stage: 'development', projectLink: '' },
            { title: 'Husky Health AI', summary: 'ML for population health with local clinics.', lookingFor: 'ML research, backend', category: 'Health', stage: 'planning', projectLink: '' },
            { title: 'Cloud Systems Lab', summary: 'Distributed systems research applied to student startups.', lookingFor: 'Systems, devops', category: 'Tech', stage: 'idea', projectLink: '' },
            { title: 'UW Sustainability Hub', summary: 'Campus-wide sustainability projects with IoT and analytics.', lookingFor: 'IoT, data viz', category: 'Sustainability', stage: 'development', projectLink: '' },
            { title: 'Lake Union Robotics', summary: 'Aquatic robotics for monitoring and cleanup.', lookingFor: 'Robotics, mechE', category: 'Tech', stage: 'planning', projectLink: '' }
          ];
          {
            const uniName = 'University of Washington';
            const need = 5 - postsToSet.filter(p => p.university === uniName).length;
            for (let i = 0; i < need; i++) {
              const authors = usersToSet.filter(u => u.university === uniName);
              if (authors.length === 0) break;
              const author = authors[i % authors.length];
              const project = uwProjects[i % uwProjects.length];
              postsToSet.push({
                id: (Math.max(0, ...postsToSet.map(p => p.id || 0)) + 1),
                userId: author.id,
                university: uniName,
                title: project.title,
                summary: project.summary,
                lookingFor: project.lookingFor,
                category: project.category,
                projectLink: project.projectLink,
                stage: project.stage,
                createdAt: new Date().toISOString().split('T')[0],
                comments: []
              });
            }
          }
          // Seed Austin: UT Austin with 5 posts
          const utaProjects = [
            { title: 'Longhorn AI Lab', summary: 'Applied AI teams tackling real problems with Austin partners.', lookingFor: 'ML, product', category: 'Tech', stage: 'development', projectLink: '' },
            { title: 'Austin Mobility', summary: 'Urban mobility analytics for multi-modal transport.', lookingFor: 'Data, backend', category: 'Civic Tech', stage: 'planning', projectLink: '' },
            { title: 'Texas HealthTech', summary: 'Digital health tools with Dell Med collaboration.', lookingFor: 'Mobile, HIPAA', category: 'Health', stage: 'idea', projectLink: '' },
            { title: 'Energy Frontier', summary: 'Grid optimization and storage projects with ERCOT datasets.', lookingFor: 'EE, data', category: 'Sustainability', stage: 'development', projectLink: '' },
            { title: 'Creator Commerce', summary: 'Consumer apps for creators and microbusinesses.', lookingFor: 'Frontend, growth', category: 'Tech', stage: 'planning', projectLink: '' }
          ];
          {
            const uniName = 'The University of Texas at Austin';
            const need = 5 - postsToSet.filter(p => p.university === uniName).length;
            for (let i = 0; i < need; i++) {
              const authors = usersToSet.filter(u => u.university === uniName);
              if (authors.length === 0) break;
              const author = authors[i % authors.length];
              const project = utaProjects[i % utaProjects.length];
              postsToSet.push({
                id: (Math.max(0, ...postsToSet.map(p => p.id || 0)) + 1),
                userId: author.id,
                university: uniName,
                title: project.title,
                summary: project.summary,
                lookingFor: project.lookingFor,
                category: project.category,
                projectLink: project.projectLink,
                stage: project.stage,
                createdAt: new Date().toISOString().split('T')[0],
                comments: []
              });
            }
          }
          const sanFranciscoProjects = [
            { title: 'Mission District Food Rescue', summary: 'Platform connecting SF restaurants with food banks to reduce waste. Uses ML to predict surplus food and optimize pickup routes.', lookingFor: 'Full-stack developers, logistics coordinators, nonprofit partners', category: 'Social Impact', stage: 'development', projectLink: '' },
            { title: 'BART Real-Time Analytics', summary: 'Crowdsourced platform predicting BART delays and crowding. Helps Bay Area commuters plan routes and find alternatives during disruptions.', lookingFor: 'Mobile developers, data scientists, UX designers', category: 'Tech', stage: 'planning', projectLink: '' },
            { title: 'SF Housing Equity Platform', summary: 'Data transparency tool tracking affordable housing development and displacement in SF neighborhoods. Partners with tenant advocacy groups.', lookingFor: 'Data engineers, policy researchers, community organizers', category: 'Social Impact', stage: 'idea', projectLink: '' },
            { title: 'Golden Gate Park IoT', summary: 'Sensor network monitoring environmental conditions in SF parks. Tracks air quality, biodiversity, and visitor patterns for conservation efforts.', lookingFor: 'IoT engineers, environmental scientists, data visualization specialists', category: 'Sustainability', stage: 'development', projectLink: '' },
            { title: 'Bay Area Climate Resilience', summary: 'Platform helping SF residents prepare for climate impacts like sea level rise and earthquakes. Includes resource guides and community preparedness networks.', lookingFor: 'Climate scientists, web developers, emergency management experts', category: 'Sustainability', stage: 'planning', projectLink: '' },
            { title: 'Chinatown Cultural Preservation', summary: 'Digital archive and virtual museum preserving Chinatown history and culture. Features oral histories, 3D scans of historic sites, and language learning tools.', lookingFor: 'Historians, 3D modelers, full-stack developers', category: 'Education', stage: 'idea', projectLink: '' },
            { title: 'SF Gig Worker Cooperative', summary: 'Platform enabling gig workers to form cooperatives and negotiate better terms. Provides legal resources, collective bargaining tools, and benefits pooling.', lookingFor: 'Labor organizers, legal experts, platform developers', category: 'Social Impact', stage: 'development', projectLink: '' },
            { title: 'Bay Biotech Diagnostics', summary: 'Low-cost point-of-care diagnostic devices for community health clinics. Spinout from SF State biology research with UCSF partnerships.', lookingFor: 'Biomedical engineers, regulatory specialists, clinical coordinators', category: 'Health', stage: 'planning', projectLink: '' },
            { title: 'Oakland Port Logistics AI', summary: 'ML platform optimizing shipping container logistics at Oakland Port. Reduces congestion and environmental impact through smarter routing.', lookingFor: 'ML engineers, supply chain experts, maritime specialists', category: 'Tech', stage: 'idea', projectLink: '' },
            { title: 'Tenderloin Safety Network', summary: 'Community-driven safety app connecting residents, businesses, and social services in the Tenderloin. Includes crisis intervention and resource navigation.', lookingFor: 'Social workers, mobile developers, community health workers', category: 'Social Impact', stage: 'development', projectLink: '' },
            { title: 'Bay Area Renewable Microgrid', summary: 'Community microgrid project using solar and battery storage for resilient power. Piloting in East Bay neighborhoods prone to fire-related outages.', lookingFor: 'Electrical engineers, policy advocates, financing experts', category: 'Sustainability', stage: 'planning', projectLink: '' },
            { title: 'SF Arts & Tech Incubator', summary: 'Accelerator combining creative arts and emerging tech. Supports projects in VR art, generative AI, and interactive installations.', lookingFor: 'Artists, technologists, gallery partners', category: 'Tech', stage: 'development', projectLink: '' }
          ];
          const bostonProjects = [
            { title: 'Cambridge Biotech Accelerator', summary: 'Early-stage life sciences incubator bridging Harvard and MIT research. Provides lab space, regulatory guidance, and investor connections.', lookingFor: 'Biotech researchers, regulatory consultants, venture partners', category: 'Health', stage: 'development', projectLink: '' },
            { title: 'Charles River Water Quality', summary: 'IoT sensor network monitoring Charles River ecosystem health. Real-time data on pollution, temperature, and wildlife for environmental advocacy.', lookingFor: 'Environmental engineers, data scientists, policy advocates', category: 'Sustainability', stage: 'planning', projectLink: '' },
            { title: 'Boston Housing Justice', summary: 'Platform tracking student displacement and advocating for tenant rights in Allston, Brighton, and Mission Hill. Includes legal resources and organizing tools.', lookingFor: 'Community organizers, web developers, housing lawyers', category: 'Social Impact', stage: 'idea', projectLink: '' },
            { title: 'MIT Mobility Lab', summary: 'Autonomous shuttle service pilot for Boston neighborhoods. Testing self-driving technology in challenging winter weather and dense urban environments.', lookingFor: 'Robotics engineers, computer vision specialists, urban planners', category: 'Tech', stage: 'development', projectLink: '' },
            { title: 'Fenway Arts Collective', summary: 'Digital platform connecting local Boston artists with galleries, collectors, and public art opportunities. Includes portfolio hosting and commission management.', lookingFor: 'Full-stack developers, art curators, marketing specialists', category: 'Tech', stage: 'planning', projectLink: '' },
            { title: 'Boston Public Schools Tech', summary: 'Educational technology platform partnering with BPS to provide personalized learning tools. Addresses equity gaps in STEM education.', lookingFor: 'Educational technologists, teachers, curriculum designers', category: 'Education', stage: 'idea', projectLink: '' },
            { title: 'Seaport Climate Adaptation', summary: 'Engineering solutions for coastal flooding in Boston Seaport. Combines green infrastructure with smart sensors for storm surge prediction.', lookingFor: 'Civil engineers, climate scientists, GIS specialists', category: 'Sustainability', stage: 'development', projectLink: '' },
            { title: 'Harvard Square Small Business', summary: 'E-commerce and marketing platform for local Harvard Square businesses competing with chains. Includes delivery coordination and customer loyalty programs.', lookingFor: 'Web developers, marketing specialists, local business liaisons', category: 'Finance', stage: 'planning', projectLink: '' },
            { title: 'Boston Healthcare Navigator', summary: 'App helping patients navigate complex Boston hospital systems. Provides appointment scheduling, insurance navigation, and specialist referrals.', lookingFor: 'Healthcare coordinators, mobile developers, insurance experts', category: 'Health', stage: 'development', projectLink: '' },
            { title: 'Northeastern Co-op Marketplace', summary: 'Job board and networking platform connecting Northeastern co-op students with startups and tech companies. Includes skill assessments and career guidance.', lookingFor: 'Full-stack developers, career counselors, HR professionals', category: 'Education', stage: 'planning', projectLink: '' },
            { title: 'Boston Marathon Analytics', summary: 'Performance tracking and training platform for runners preparing for Boston Marathon. Uses wearable data and ML for personalized coaching.', lookingFor: 'Sports scientists, mobile developers, ML engineers', category: 'Health', stage: 'idea', projectLink: '' },
            { title: 'Back Bay Energy Efficiency', summary: 'Retrofitting historic Back Bay buildings with modern energy-efficient systems. Balances preservation requirements with sustainability goals.', lookingFor: 'Mechanical engineers, architects, historic preservation specialists', category: 'Sustainability', stage: 'development', projectLink: '' }
          ];
          let addedCityPosts = false;
          const ensurePostForUni = (uniName, project) => {
            const exists = postsToSet.some(p => p.university === uniName);
            if (exists) return;
            const uniUsers = usersToSet.filter(u => u.university === uniName);
            if (uniUsers.length === 0) return;
            const author = uniUsers[0];
            const newPost = {
              id: (Math.max(0, ...postsToSet.map(p => p.id || 0)) + 1),
              userId: author.id,
              university: uniName,
              title: project.title,
              summary: project.summary,
              lookingFor: project.lookingFor,
              category: project.category,
              projectLink: project.projectLink,
              stage: project.stage,
              createdAt: new Date().toISOString().split('T')[0],
              comments: []
            };
            postsToSet.push(newPost);
            addedCityPosts = true;
          };
          const ensurePostsCountForUni = (uniName, projectList, count) => {
            let current = postsToSet.filter(p => p.university === uniName).length;
            while (current < count) {
              const idx = current % projectList.length;
              const project = projectList[idx];
              const authors = usersToSet.filter(u => u.university === uniName);
              if (authors.length === 0) break;
              const author = authors[current % authors.length];
              const newPost = {
                id: (Math.max(0, ...postsToSet.map(p => p.id || 0)) + 1),
                userId: author.id,
                university: uniName,
                title: project.title,
                summary: project.summary,
                lookingFor: project.lookingFor,
                category: project.category,
                projectLink: project.projectLink,
                stage: project.stage,
                createdAt: new Date().toISOString().split('T')[0],
                comments: []
              };
              postsToSet.push(newPost);
              current++;
              addedCityPosts = true;
            }
          };

          // Ensure Pittsburgh (CMU/Pitt) always have baseline posts, even if Firestore had other cities
          const cmuFixProjects = [
            { title: 'CMU Robotics Studio', summary: 'Service robots for campus logistics.', lookingFor: 'Robotics, CV, ROS', category: 'Tech', stage: 'development', projectLink: '' },
            { title: 'CMU EdTech AI', summary: 'LLM-driven tutor for intro CS.', lookingFor: 'NLP, full-stack', category: 'Education', stage: 'planning', projectLink: '' },
            { title: 'CMU Cyber Defense', summary: 'Threat intel for small orgs.', lookingFor: 'Security, data', category: 'Tech', stage: 'idea', projectLink: '' },
            { title: 'CMU Green Campus', summary: 'IoT metering dashboards for buildings.', lookingFor: 'IoT, data viz', category: 'Sustainability', stage: 'planning', projectLink: '' },
            { title: 'CMU Creator Tools', summary: 'Tools for student creators to monetize work.', lookingFor: 'Frontend, product', category: 'Tech', stage: 'development', projectLink: '' }
          ];
          const pittFixProjects = [
            { title: 'Pitt Health Hub', summary: 'Student mental health platform.', lookingFor: 'Clinicians, mobile devs', category: 'Health', stage: 'development', projectLink: '' },
            { title: 'Oakland Co-Work', summary: 'Student-run incubator & events.', lookingFor: 'Ops, community', category: 'Social Impact', stage: 'planning', projectLink: '' },
            { title: 'Pitt Research X', summary: 'Matchmaking for labs and industry.', lookingFor: 'BD, backend', category: 'Tech', stage: 'idea', projectLink: '' }
          ];
          ensurePostsCountForUni('Carnegie Mellon University', cmuFixProjects, 5);
          ensurePostsCountForUni('University of Pittsburgh', pittFixProjects, 3);
          // Create one post per SF/Boston uni if no posts yet
          sanFranciscoUniversities.forEach((uni, idx) => ensurePostForUni(uni.name, sanFranciscoProjects[idx % sanFranciscoProjects.length]));
          bostonUniversities.forEach((uni, idx) => ensurePostForUni(uni.name, bostonProjects[idx % bostonProjects.length]));
          // Ensure at least 3 per university in these cities
          sanFranciscoUniversities.forEach((uni) => ensurePostsCountForUni(uni.name, sanFranciscoProjects, 3));
          bostonUniversities.forEach((uni) => ensurePostsCountForUni(uni.name, bostonProjects, 3));
          if (addedCityPosts) {
            await saveToFirestoreApp('posts', postsToSet);
          }

          // Ensure Pittsburgh authors and posts exist even if Firestore had other cities (fix for CMU/Pitt)
          (function ensurePittsburghAlways() {
            const ensureMinUsersForUni = (uniName, emailDomain, minCount) => {
              const existing = usersToSet.filter(u => u.university === uniName);
              let nextId = Math.max(0, ...usersToSet.map(u => u.id || 0)) + 1;
              const seed = [
                { first: 'Alex', last: 'Chen' }, { first: 'Maya', last: 'Patel' },
                { first: 'David', last: 'Kim' }, { first: 'Sarah', last: 'Johnson' },
                { first: 'Emily', last: 'Thompson' }
              ];
              for (let i = existing.length; i < minCount; i++) {
                const n = seed[i % seed.length];
                const uniObj = universitiesToSet.find(u => u.name === uniName);
                usersToSet.push({
                  id: nextId++,
                  email: `${n.first.toLowerCase()}${n.last.toLowerCase()}@${emailDomain}`,
                  university: uniName,
                  lat: uniObj?.lat || getDefaultCoordinates().lat,
                  lng: uniObj?.lng || getDefaultCoordinates().lng,
                  profile: { firstName: n.first, lastName: n.last, bio: `${n.first} ${n.last} is a student at ${uniName}.`, picture: getRandomAvatar(), graduationYear: '2025', hasIdea: 'yes', isWorkingOnIdea: 'yes', social: {} }
                });
              }
            };

            const cmuDomain = (universitiesToSet.find(u => u.name === 'Carnegie Mellon University')?.emailDomain) || 'cmu.edu';
            const pittDomain = (universitiesToSet.find(u => u.name === 'University of Pittsburgh')?.emailDomain) || 'pitt.edu';
            ensureMinUsersForUni('Carnegie Mellon University', cmuDomain, 5);
            ensureMinUsersForUni('University of Pittsburgh', pittDomain, 3);

            const cmuFixProjects = [
              { title: 'CMU Robotics Studio', summary: 'Service robots for campus logistics.', lookingFor: 'Robotics, CV, ROS', category: 'Tech', stage: 'development', projectLink: '' },
              { title: 'CMU EdTech AI', summary: 'LLM-driven tutor for intro CS.', lookingFor: 'NLP, full-stack', category: 'Education', stage: 'planning', projectLink: '' },
              { title: 'CMU Cyber Defense', summary: 'Threat intel for small orgs.', lookingFor: 'Security, data', category: 'Tech', stage: 'idea', projectLink: '' },
              { title: 'CMU Green Campus', summary: 'IoT metering dashboards for buildings.', lookingFor: 'IoT, data viz', category: 'Sustainability', stage: 'planning', projectLink: '' },
              { title: 'CMU Creator Tools', summary: 'Tools for student creators to monetize work.', lookingFor: 'Frontend, product', category: 'Tech', stage: 'development', projectLink: '' }
            ];
            const pittFixProjects = [
              { title: 'Pitt Health Hub', summary: 'Student mental health platform.', lookingFor: 'Clinicians, mobile devs', category: 'Health', stage: 'development', projectLink: '' },
              { title: 'Oakland Co-Work', summary: 'Student-run incubator & events.', lookingFor: 'Ops, community', category: 'Social Impact', stage: 'planning', projectLink: '' },
              { title: 'Pitt Research X', summary: 'Matchmaking for labs and industry.', lookingFor: 'BD, backend', category: 'Tech', stage: 'idea', projectLink: '' }
            ];
            ensurePostsCountForUni('Carnegie Mellon University', cmuFixProjects, 5);
            ensurePostsCountForUni('University of Pittsburgh', pittFixProjects, 3);
          })();

          setUsers(usersToSet);
          setPosts(postsToSet);
          setIsLoading(false);
          setIsInitializing(false);
        } catch (error) {
          console.error('Failed to fetch data:', error);
          setError('Failed to load data. Please refresh the page.');
          setIsLoading(false);
          setIsInitializing(false);
        }
      };
      fetchData();
    }, []);

    // Admin reset all Firestore data via ?resetData=1
    useEffect(() => {
      const params = new URLSearchParams(window.location.search || '');
      if (params.get('resetData') === '1') {
        console.log('[ADMIN] Resetting all Firestore data...');
        (async () => {
          try {
            // Clear all Firestore data by setting empty arrays
            await saveToFirestore('app', 'posts', { data: [] });
            await saveToFirestore('app', 'users', { data: [] });
            await saveToFirestore('app', 'universities', { data: [] });
            console.log('[ADMIN] Firestore data cleared. Refresh page without ?resetData=1 to regenerate.');
            alert('Firestore data cleared! Please refresh the page without ?resetData=1 to regenerate with new unique projects.');
          } catch (e) {
            console.error('[ADMIN] Reset failed:', e);
          }
        })();
      }
    }, []);

    // Admin prune for Pittsburgh posts via ?prunePgh=1
    useEffect(() => {
      const params = new URLSearchParams(window.location.search || '');
      if (params.get('prunePgh') !== '1') return;
      try {
        const allowed = new Set([
          'Carnegie Mellon University',
          'University of Pittsburgh',
          'Duquesne University',
          'Robert Morris University',
          'Point Park University'
        ]);
        const pruned = posts.filter(p => {
          const city = inferCityByName(p.university);
          if (city !== 'Pittsburgh') return true;
          return allowed.has(p.university);
        });
        if (pruned.length !== posts.length) {
          setPosts(pruned);
          (async () => { try { await saveToFirestoreApp('posts', pruned); } catch(_) {} })();
          console.log(`[ADMIN] Pruned Pittsburgh posts. Before=${posts.length}, After=${pruned.length}`);
        } else {
          console.log('[ADMIN] No Pittsburgh posts needed pruning.');
        }
      } catch (e) {
        console.warn('[ADMIN] prunePgh failed', e);
      }
    }, [posts]);

    // Admin reseed for Pittsburgh via ?seedPgh=1
    useEffect(() => {
      const params = new URLSearchParams(window.location.search || '');
      if (params.get('seedPgh') !== '1') return;
      (async () => {
        try {
          console.log('[ADMIN] Resetting Pittsburgh users/posts...');
          const pghUnis = pittsburghUniversities.map(u => ({ ...u }));
          const seedNames = [
            { firstName: 'Alex', lastName: 'Chen' },
            { firstName: 'Maya', lastName: 'Patel' },
            { firstName: 'David', lastName: 'Kim' },
            { firstName: 'Sarah', lastName: 'Johnson' },
            { firstName: 'Emily', lastName: 'Thompson' },
            { firstName: 'Jordan', lastName: 'Davis' },
            { firstName: 'Aisha', lastName: 'Hassan' },
            { firstName: 'Michael', lastName: "O'Connor" }
          ];
          let uid = 1;
          const seededUsers = pghUnis.flatMap((uni, idx) => {
            const perUni = 5;
            const arr = [];
            for (let i = 0; i < perUni; i++) {
              const n = seedNames[(idx * perUni + i) % seedNames.length];
              arr.push({
                id: uid++, email: `${n.firstName.toLowerCase()}${n.lastName.toLowerCase()}@${uni.emailDomain}`,
                university: uni.name, lat: uni.lat, lng: uni.lng,
                profile: { firstName: n.firstName, lastName: n.lastName, bio: `${n.firstName} ${n.lastName} at ${uni.name}.`, picture: getRandomAvatar(), graduationYear: '2025', hasIdea: 'yes', isWorkingOnIdea: 'yes', social: {} }
              });
            }
            return arr;
          });
          const cmuFix = [
            { title: 'CMU Robotics Studio', summary: 'Service robots for campus logistics.', lookingFor: 'Robotics, CV, ROS', category: 'Tech', stage: 'development', projectLink: '' },
            { title: 'CMU EdTech AI', summary: 'LLM-driven tutor for intro CS.', lookingFor: 'NLP, full-stack', category: 'Education', stage: 'planning', projectLink: '' },
            { title: 'CMU Cyber Defense', summary: 'Threat intel for small orgs.', lookingFor: 'Security, data', category: 'Tech', stage: 'idea', projectLink: '' },
            { title: 'CMU Green Campus', summary: 'IoT metering dashboards.', lookingFor: 'IoT, data viz', category: 'Sustainability', stage: 'planning', projectLink: '' },
            { title: 'CMU Creator Tools', summary: 'Tools for student creators.', lookingFor: 'Frontend, product', category: 'Tech', stage: 'development', projectLink: '' }
          ];
          const pittFix = [
            { title: 'Pitt Health Hub', summary: 'Student mental health platform.', lookingFor: 'Clinicians, mobile devs', category: 'Health', stage: 'development', projectLink: '' },
            { title: 'Oakland Co-Work', summary: 'Student-run incubator & events.', lookingFor: 'Ops, community', category: 'Social Impact', stage: 'planning', projectLink: '' },
            { title: 'Pitt Research X', summary: 'Matchmaking for labs and industry.', lookingFor: 'BD, backend', category: 'Tech', stage: 'idea', projectLink: '' }
          ];
          let pid = 1;
          const seededPosts = [];
          const authors = (u, n) => seededUsers.filter(x => x.university === u).slice(0, n);
          authors('Carnegie Mellon University', 5).forEach((a, i) => { const pr = cmuFix[i % cmuFix.length]; seededPosts.push({ id: pid++, userId: a.id, university: a.university, title: pr.title, summary: pr.summary, lookingFor: pr.lookingFor, category: pr.category, projectLink: pr.projectLink, stage: pr.stage, createdAt: new Date().toISOString().split('T')[0], comments: [] }); });
          authors('University of Pittsburgh', 3).forEach((a, i) => { const pr = pittFix[i % pittFix.length]; seededPosts.push({ id: pid++, userId: a.id, university: a.university, title: pr.title, summary: pr.summary, lookingFor: pr.lookingFor, category: pr.category, projectLink: pr.projectLink, stage: pr.stage, createdAt: new Date().toISOString().split('T')[0], comments: [] }); });
          try { await saveToFirestoreApp('users', seededUsers); } catch(e) {}
          try { await saveToFirestoreApp('posts', seededPosts); } catch(e) {}
          setUsers(prev => [...prev.filter(u => inferCityByName(u.university) !== 'Pittsburgh'), ...seededUsers]);
          setPosts(prev => [...prev.filter(p => inferCityByName(p.university) !== 'Pittsburgh'), ...seededPosts]);
          console.log('[ADMIN] Pittsburgh reseed complete');
        } catch (e) {
          console.error('[ADMIN] Seed Pittsburgh failed', e);
        }
      })();
    }, []);

      // Function to set the view to a specific user's profile
      const viewUserProfile = (userId) => {
        setSelectedUserId(userId);
        setView("profile-view");
      };

      // Handle Google Sign In
      const handleGoogleSignIn = async () => {
        const provider = new window.firebase.GoogleAuthProvider();
        try {
          await window.firebase.signInWithPopup(window.firebase.auth, provider);
        } catch (error) {
          console.error("Error signing in with Google:", error);
          alert("Error signing in with Google. Please try again.");
        }
      };

      // Handle Email/Password Sign In
      const handleEmailSignIn = async (email, password) => {
        try {
          const result = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);

          
          // The auth state change listener will handle the rest
        } catch (error) {
          console.error("Error signing in:", error);
          alert("Error signing in. Please try again.");
        }
      };

      // Handle Email/Password Sign Up
      const handleEmailSignUp = async (email, password) => {
        try {
          const result = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);

          
          // The auth state change listener will handle the rest
        } catch (error) {
          console.error("Error signing up:", error);
          alert("Error signing up. Please try again.");
        }
      };

      // Handle Sign Out
      const handleSignOut = async () => {
        try {
          await window.firebase.signOut(window.firebase.auth);
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };

      // Save profile
      const handleProfileSave = (profile) => {
        if (!user) return; // Add null check
        
        console.log('Saving profile for user:', user.id, profile);
        
        const newUser = { 
          ...user, 
          profile: { 
            ...profile, 
            picture: profile.picture || getRandomAvatar() 
          } 
        };
        
        console.log('New user object:', newUser);
        
        setUsers(users.map(u => u.id === user.id ? newUser : u));
        setUser(newUser);
        setView("board");
      };

      // Update profile
      const handleProfileUpdate = (profile) => {
        if (!user) return; // Add null check
        
        console.log('Updating profile for user:', user.id, profile);
        
        const updatedUser = { 
          ...user, 
          profile: { 
            ...profile, 
            picture: profile.picture || user.profile?.picture 
          } 
        };
        
        console.log('Updated user object:', updatedUser);
        
        setUsers(users.map(u => u.id === user.id ? updatedUser : u));
        setUser(updatedUser);
        setView("profile-view");
      };

      // Create post
      const handleCreatePost = (post) => {
        if (!user) return; // Add null check
        
        setPosts([...posts, { 
          id: posts.length + 1, 
          userId: user.id, 
          university: user.university, 
          ...post, 
          createdAt: new Date().toISOString().split("T")[0], 
          comments: [] 
        }]);
        setView("board");
      };

      // Edit post
      const handleEditPost = (postId, updatedPost) => {
        if (!user) return; // Add null check
        
        setPosts(posts.map(p => p.id === postId ? { ...p, ...updatedPost } : p));
        setView("board");
      };

      // Delete post
      const handleDeletePost = (postId) => {
        if (!user) return; // Add null check
        
        setPosts(posts.filter(p => p.id !== postId));
        setView("board");
      };

      // Add comment
      const handleAddComment = (postId, comment) => {
        if (!user) return; // Add null check
        
        setPosts(posts.map(p => p.id === postId ? { 
          ...p, 
          comments: [...p.comments, { 
            id: p.comments.length + 1, 
            userId: user.id, 
            text: comment, 
            createdAt: new Date().toISOString().split("T")[0] 
          }] 
        } : p));
      };

      // Handle university filter from map
      const handleUniversityFilter = (universityName) => {
        setUniversityFilter(universityName);
      };

      // Clear university filter
      const clearUniversityFilter = () => {
        setUniversityFilter(null);
      };

      // Filter posts by university or proximity
      const filteredPosts = user ? posts.filter(post => {
        // If university filter is active, only show posts from that university
        if (universityFilter) {
          return post.university === universityFilter;
        }
        
        // Otherwise, use the distance filter for local view
        const postUni = universities.find(u => u.name === post.university);
        if (post.university === user.university) return true;
        if (postUni && user.lat && user.lng) {
          const distance = getDistance(user.lat, user.lng, postUni.lat, postUni.lng);
          return distance <= distanceFilter;
        }
        return false;
      }) : [];
          // City view should not require auth; always filter by selected city
          const cityFilteredPosts = posts.filter(post => {
            if (universityFilter) return post.university === universityFilter;
            const postUni = universities.find(u => u.name === post.university);
            const city = postUni?.city || inferCity(post.university);
            return city === selectedCity;
          });
      
      // Apply visibility rules: Global = 5 most recent; City = top 5; Local = nearby (only for signed-in)
      let displayedPosts;
      if (feedMode === 'global') {
        displayedPosts = [...posts].sort((a,b) => new Date(b.createdAt||0)-new Date(a.createdAt||0)).slice(0,20);
      } else if (feedMode === 'city') {
        displayedPosts = cityFilteredPosts.slice(0,5);
      } else {
        displayedPosts = filteredPosts;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 font-sans">
          {/* Header */}
          <header className="bg-white shadow-md">
            <div className="container mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-8">
                <button 
                  onClick={() => { setView("board"); setFeedMode("global"); setUniversityFilter(null); try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(_) {} }}
                  className="flex items-center space-x-3 focus:outline-none"
                  title="Go to Global"
                >
                  <svg className="w-9 h-9 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                  </svg>
                  <h1 className="text-2xl font-bold text-gray-800">UniStartupBoard</h1>
                </button>
                  {user && (
                    <button 
                      onClick={() => setView("board")} 
                      className="px-5 py-2 text-gray-700 hover:text-orange-500 transition-colors font-mono text-base font-medium border-b-2 border-transparent hover:border-orange-500"
                    >
                      Map
                    </button>
                  )}
                </div>
                <nav>
                {user ? (
                    <div className="flex items-center space-x-6">
                      <button 
                        onClick={() => setView("about")} 
                        className="px-5 py-2 text-gray-700 hover:text-orange-500 transition-colors font-mono text-sm font-medium border-b-2 border-transparent hover:border-orange-500"
                      >
                        About
                      </button>
                      <button 
                        onClick={() => setView("create")} 
                        className="px-5 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-mono text-sm font-medium shadow-sm hover:shadow-md"
                      >
                        Create Post
                      </button>
                      <button 
                        onClick={() => setView("profile-view")} 
                        className="px-5 py-2 text-gray-700 hover:text-orange-500 transition-colors font-mono text-sm font-medium border-b-2 border-transparent hover:border-orange-500"
                      >
                        Profile
                      </button>
                      <button 
                        onClick={handleSignOut} 
                        className="px-5 py-2 text-gray-600 hover:text-orange-500 transition-colors font-mono text-sm font-medium border-b-2 border-transparent hover:border-orange-500"
                      >
                        Sign Out
                      </button>
                  </div>
                ) : (
                    <div className="flex items-center space-x-6">
                      <button 
                        onClick={() => setView("about")} 
                        className="px-5 py-2 text-gray-700 hover:text-orange-500 transition-colors font-mono text-sm font-medium border-b-2 border-transparent hover:border-orange-500"
                      >
                        About
                      </button>
                      <button 
                        onClick={() => setView("signin")} 
                        className="px-5 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-mono text-sm font-medium shadow-sm hover:shadow-md"
                      >
                        Sign In
                      </button>
                    </div>
                )}
              </nav>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <main className={`container mx-auto px-4 ${view === 'board' ? 'py-4' : 'py-8'}`}>
            {view === "signin" && (
              <div className="max-w-md mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    {actionNotice && (
                      <div className="mb-4 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded px-3 py-2 text-sm font-mono">
                        {actionNotice}
                      </div>
                    )}
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Welcome Back</h2>
                    <SignInForm 
                      onGoogleSignIn={handleGoogleSignIn} 
                      onEmailSignIn={handleEmailSignIn}
                      onEmailSignUp={handleEmailSignUp}
                      setView={setView}
                      user={user}
                      selectedUserId={selectedUserId}
                      viewUserProfile={viewUserProfile}
                      universities={universities}
                      domainIndex={domainIndex}
                    />
                  </div>
                </div>
              </div>
            )}
            {view === "profile" && user && (
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Set Up Your Profile</h2>
              <ProfileForm onSave={handleProfileSave} />
                  </div>
                </div>
              </div>
            )}
            {view === "profile-view" && user && (
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
              <ProfileView user={user} users={users} selectedUserId={selectedUserId} onEdit={() => { if (!user) { setView('signin'); return; } setView("profile-edit"); }} />
                  </div>
                </div>
              </div>
            )}
            {view === "profile-edit" && user && (
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Edit Profile</h2>
              <ProfileForm onSave={handleProfileUpdate} initialProfile={user.profile} />
                  </div>
                </div>
              </div>
            )}
            {view === "board" && (
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="px-8 pt-3 pb-8">
                    {/* Loading State */}
                    {isLoading && (
                      <div className="text-center py-8">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
                        <p className="mt-2 text-gray-600">Loading startup projects...</p>
                      </div>
                    )}
                    
                    {/* Error State */}
                    {error && (
                      <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <p className="text-red-800">{error}</p>
                        <button 
                          onClick={() => window.location.reload()} 
                          className="mt-2 text-red-600 hover:text-red-800 underline"
                        >
                          Refresh Page
                        </button>
                      </div>
                    )}
                    
                    {/* Content */}
                    {!isLoading && !error && (
                      <>
                        {feedMode === 'local' && (
                          <MapView 
                            user={user} 
                            posts={filteredPosts} 
                            users={users} 
                            onUniversityFilter={handleUniversityFilter}
                            title="Startup Projects Near You"
                          />
                        )}
                    {feedMode === 'city' && (
                      <MapView 
                        user={user} 
                        posts={cityFilteredPosts} 
                        users={users} 
                        onUniversityFilter={handleUniversityFilter}
                        center={(function(){
                          // Fixed coordinates that match the screenshots exactly
                          if (selectedCity === 'San Francisco') {
                            // Center a bit south-east of downtown to frame SF + Peninsula (Stanford, SJSU, SCU) and East Bay (Berkeley)
                            return {lat: 37.55, lng: -122.15};
                          } else if (selectedCity === 'Boston') {
                            // Center between BU (42.3505, -71.1054) and MIT (42.3601, -71.0942)
                            return {lat: 42.3553, lng: -71.0998};
                          } else if (selectedCity === 'Pittsburgh') {
                            // Center on MLK Community Garden in Hill District
                            return {lat: 40.4450, lng: -79.9850};
                          } else if (selectedCity === 'New York City') {
                            // Center between Columbia (Morningside), NYU (Greenwich), and Cornell Tech (Roosevelt Island)
                            return {lat: 40.764, lng: -73.981};
                          } else if (selectedCity === 'Seattle') {
                            // Focus on UW area while keeping greater Seattle in frame
                            return {lat: 47.63, lng: -122.33};
                          } else if (selectedCity === 'Austin') {
                            // Focus on UT Austin and central Austin
                            return {lat: 30.28, lng: -97.74};
                          }
                          // Fallback to university average for other cities
                          const cityUnis = universities.filter(u => u.city === selectedCity);
                          if (cityUnis.length === 0) return null;
                          const avgLat = cityUnis.reduce((s,u)=>s+u.lat,0)/cityUnis.length;
                          const avgLng = cityUnis.reduce((s,u)=>s+u.lng,0)/cityUnis.length;
                          return {lat: avgLat, lng: avgLng};
                        })()}
                        zoom={(function(){
                          // Fixed zoom levels that match the screenshots exactly
                          if (selectedCity === 'San Francisco') {
                            return 9.5; // Slightly closer but still shows all 6 Bay Area schools
                          } else if (selectedCity === 'Boston') {
                            return 13; // Same zoom as Pittsburgh to show Cambridge, Somerville, Back Bay, South End clearly
                          } else if (selectedCity === 'Pittsburgh') {
                            return 13; // More zoomed in to show downtown, rivers, Oakland clearly
                          } else if (selectedCity === 'New York City') {
                            return 12; // Show Manhattan/Brooklyn core to include Columbia, NYU, Cornell Tech
                          } else if (selectedCity === 'Chicago') {
                            return 11; // Slightly more zoomed out to include UChicago, UIC, IIT, Loyola, Northwestern
                          }
                          return 12; // Default zoom
                        })()}
                        showUserMarker={false}
                        title={`${selectedCity} Startup Projects`}
                      />
                    )}
                    <div className="mt-8">
                      <PostBoard 
                        posts={displayedPosts} 
                        user={user} 
                        onEditPost={handleEditPost} 
                        onDeletePost={handleDeletePost} 
                        onAddComment={handleAddComment} 
                        users={users} 
                        setView={setView} 
                        selectedUserId={selectedUserId}
                        viewUserProfile={viewUserProfile}
                        feedMode={feedMode}
                        setFeedMode={setFeedMode}
                        selectedCity={selectedCity}
                        setSelectedCity={setSelectedCity}
                        universities={universities}
                        universityFilter={universityFilter}
                        clearUniversityFilter={clearUniversityFilter}
                        distanceFilter={distanceFilter}
                        setDistanceFilter={setDistanceFilter}
                        promptSignIn={promptSignIn}
                      />
                    </div>
                      </>
                    )}
                  </div>
                </div>
              </div>
            )}
            {view === "posts" && (
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    <PostBoard 
                      posts={displayedPosts} 
                      user={user} 
                      onEditPost={handleEditPost} 
                      onDeletePost={handleDeletePost} 
                      onAddComment={handleAddComment} 
                      users={users} 
                      setView={setView} 
                      selectedUserId={selectedUserId}
                      viewUserProfile={viewUserProfile}
                      feedMode={feedMode}
                      setFeedMode={setFeedMode}
                      selectedCity={selectedCity}
                      setSelectedCity={setSelectedCity}
                      universities={universities}
                      universityFilter={universityFilter}
                      clearUniversityFilter={clearUniversityFilter}
                      distanceFilter={distanceFilter}
                      setDistanceFilter={setDistanceFilter}
                    />
                  </div>
                </div>
              </div>
            )}
            {view === "create" && user && (
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Create a New Post</h2>
              <CreatePostForm onCreate={handleCreatePost} />
                  </div>
                </div>
              </div>
            )}
            {view.startsWith("edit-") && user && (
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Edit Post</h2>
              <CreatePostForm
                onCreate={(post) => handleEditPost(parseInt(view.split("-")[1]), post)}
                initialPost={posts.find(p => p.id === parseInt(view.split("-")[1]))}
              />
                  </div>
                </div>
              </div>
            )}
            {view.startsWith("post-") && (
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
              <PostView
                post={posts.find(p => p.id === parseInt(view.split("-")[1]))}
                user={user}
                users={users}
                onEdit={() => setView(`edit-${view.split("-")[1]}`)}
                onDelete={() => handleDeletePost(parseInt(view.split("-")[1]))}
                onAddComment={handleAddComment}
                setView={setView}
                selectedUserId={selectedUserId}
                viewUserProfile={viewUserProfile}
              />
                  </div>
                </div>
              </div>
            )}
            {view === "about" && (
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="p-8">
                    <AboutPage setView={setView} user={user} />
                  </div>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    // All 300 known university domains - embedded directly for instant recognition
    const ALL_UNIVERSITY_DOMAINS = {"albany.edu":"University at Albany","alcorn.edu":"Alcorn State University","appstate.edu":"Appalachian State University","apsu.edu":"Austin Peay State University","arizona.edu":"University of Arizona","arkansasstate.edu":"Arkansas State University","asu.edu":"Arizona State University","auburn.edu":"Auburn University","augusta.edu":"Augusta University","baruch.cuny.edu":"Baruch College (CUNY)","bc.edu":"Boston College","berkeley.edu":"University of California, Berkeley","bgsu.edu":"Bowling Green State University","binghamton.edu":"Binghamton University","boisestate.edu":"Boise State University","brandeis.edu":"Brandeis University","brooklyn.cuny.edu":"Brooklyn College (CUNY)","brown.edu":"Brown University","bsu.edu":"Ball State University","bu.edu":"Boston University","buffalo.edu":"University at Buffalo","byu.edu":"Brigham Young University","calpoly.edu":"California Polytechnic State University, San Luis Obispo","caltech.edu":"California Institute of Technology","case.edu":"Case Western Reserve University","cau.edu":"Clark Atlanta University","ccny.cuny.edu":"City College of New York (CUNY)","charlotte.edu":"University of North Carolina at Charlotte","citadel.edu":"The Citadel","citytech.cuny.edu":"CUNY New York City College of Technology","clemson.edu":"Clemson University","cmu.edu":"Carnegie Mellon University","cnu.edu":"Christopher Newport University","cofc.edu":"College of Charleston","colorado.edu":"University of Colorado Boulder","colostate.edu":"Colorado State University","columbia.edu":"Columbia University","cornell.edu":"Cornell University","cpp.edu":"California State Polytechnic University, Pomona","creighton.edu":"Creighton University","csuchico.edu":"California State University, Chico","csuci.edu":"California State University Channel Islands","csulb.edu":"California State University, Long Beach","csun.edu":"California State University, Northridge","csus.edu":"California State University, Sacramento","csusb.edu":"California State University, San Bernardino","cuny.edu":"City University of New York","cwu.edu":"Central Washington University","dartmouth.edu":"Dartmouth College","dayton.edu":"University of Dayton","depaul.edu":"DePaul University","drexel.edu":"Drexel University","duke.edu":"Duke University","ecu.edu":"East Carolina University","eku.edu":"Eastern Kentucky University","emory.edu":"Emory University","etsu.edu":"East Tennessee State University","ewu.edu":"Eastern Washington University","famu.edu":"Florida A&M University","fau.edu":"Florida Atlantic University","fiu.edu":"Florida International University","fordham.edu":"Fordham University","fresnostate.edu":"California State University, Fresno","frostburg.edu":"Frostburg State University","fsu.edu":"Florida State University","fullerton.edu":"California State University, Fullerton","gatech.edu":"Georgia Institute of Technology","gc.cuny.edu":"CUNY Graduate Center","georgetown.edu":"Georgetown University","georgiasouthern.edu":"Georgia Southern University","gmu.edu":"George Mason University","gonzaga.edu":"Gonzaga University","gsu.edu":"Georgia State University","hamptonu.edu":"Hampton University","harvard.edu":"Harvard University","hawaii.edu":"University of Hawaiʻi at Mānoa","howard.edu":"Howard University","humboldt.edu":"Cal Poly Humboldt","hunter.cuny.edu":"Hunter College (CUNY)","iastate.edu":"Iowa State University","illinois.edu":"University of Illinois Urbana-Champaign","illinoisstate.edu":"Illinois State University","indiana.edu":"Indiana University Bloomington","indstate.edu":"Indiana State University","isu.edu":"Idaho State University","iu.edu":"Indiana University Bloomington","jhu.edu":"Johns Hopkins University","jjay.cuny.edu":"John Jay College of Criminal Justice (CUNY)","jmu.edu":"James Madison University","jsums.edu":"Jackson State University","k-state.edu":"Kansas State University","kean.edu":"Kean University","kennesaw.edu":"Kennesaw State University","kent.edu":"Kent State University","ku.edu":"University of Kansas","latech.edu":"Louisiana Tech University","lehigh.edu":"Lehigh University","lehman.cuny.edu":"Lehman College (CUNY)","lmu.edu":"Loyola Marymount University","louisiana.edu":"University of Louisiana at Lafayette","louisville.edu":"University of Louisville","lsu.edu":"Louisiana State University","luc.edu":"Loyola University Chicago","marquette.edu":"Marquette University","marshall.edu":"Marshall University","memphis.edu":"The University of Memphis","miami.edu":"University of Miami","miamioh.edu":"Miami University","mines.edu":"Colorado School of Mines","missouri.edu":"University of Missouri","mit.edu":"Massachusetts Institute of Technology","montana.edu":"Montana State University","montclair.edu":"Montclair State University","moreheadstate.edu":"Morehead State University","morehouse.edu":"Morehouse College","morgan.edu":"Morgan State University","msstate.edu":"Mississippi State University","mst.edu":"Missouri University of Science and Technology","msu.edu":"Michigan State University","msubillings.edu":"Montana State University Billings","mtsu.edu":"Middle Tennessee State University","murraystate.edu":"Murray State University","nau.edu":"Northern Arizona University","ncat.edu":"North Carolina A&T State University","ncsu.edu":"North Carolina State University","nd.edu":"University of Notre Dame","ndsu.edu":"North Dakota State University","niu.edu":"Northern Illinois University","njit.edu":"New Jersey Institute of Technology","nku.edu":"Northern Kentucky University","nmsu.edu":"New Mexico State University","nmt.edu":"New Mexico Institute of Mining and Technology","northeastern.edu":"Northeastern University","northwestern.edu":"Northwestern University","nyu.edu":"New York University","odu.edu":"Old Dominion University","ohio.edu":"Ohio University","okstate.edu":"Oklahoma State University","olemiss.edu":"University of Mississippi","oregonstate.edu":"Oregon State University","osu.edu":"The Ohio State University","ou.edu":"University of Oklahoma","pdx.edu":"Portland State University","pepperdine.edu":"Pepperdine University","pitt.edu":"University of Pittsburgh","plymouth.edu":"Plymouth State University","princeton.edu":"Princeton University","psu.edu":"Pennsylvania State University","purdue.edu":"Purdue University","pvamu.edu":"Prairie View A&M University","qc.cuny.edu":"Queens College (CUNY)","rice.edu":"Rice University","rit.edu":"Rochester Institute of Technology","rochester.edu":"University of Rochester","rowan.edu":"Rowan University","rpi.edu":"Rensselaer Polytechnic Institute","rutgers.edu":"Rutgers University–New Brunswick","salisbury.edu":"Salisbury University","sandiego.edu":"University of San Diego","sc.edu":"University of South Carolina","scu.edu":"Santa Clara University","sdstate.edu":"South Dakota State University","sdsu.edu":"San Diego State University","setonhall.edu":"Seton Hall University","sfsu.edu":"San Francisco State University","siu.edu":"Southern Illinois University Carbondale","siue.edu":"Southern Illinois University Edwardsville","sjsu.edu":"San José State University","smu.edu":"Southern Methodist University","sonoma.edu":"Sonoma State University","southalabama.edu":"University of South Alabama","spelman.edu":"Spelman College","stanford.edu":"Stanford University","stevens.edu":"Stevens Institute of Technology","stonybrook.edu":"Stony Brook University","syracuse.edu":"Syracuse University","tamu.edu":"Texas A&M University","tcnj.edu":"The College of New Jersey","tcu.edu":"Texas Christian University","temple.edu":"Temple University","tnstate.edu":"Tennessee State University","tntech.edu":"Tennessee Tech University","towson.edu":"Towson University","troy.edu":"Troy University","truman.edu":"Truman State University","tsu.edu":"Texas Southern University","ttu.edu":"Texas Tech University","tufts.edu":"Tufts University","twu.edu":"Texas Woman's University","txst.edu":"Texas State University","ua.edu":"The University of Alabama","uaa.alaska.edu":"University of Alaska Anchorage","uab.edu":"University of Alabama at Birmingham","uaf.edu":"University of Alaska Fairbanks","uakron.edu":"The University of Akron","uark.edu":"University of Arkansas","uas.alaska.edu":"University of Alaska Southeast","uc.edu":"University of Cincinnati","uccs.edu":"University of Colorado Colorado Springs","ucdavis.edu":"University of California, Davis","ucf.edu":"University of Central Florida","uchicago.edu":"University of Chicago","uci.edu":"University of California, Irvine","ucla.edu":"University of California, Los Angeles","ucmerced.edu":"University of California, Merced","uco.edu":"University of Central Oklahoma","uconn.edu":"University of Connecticut","ucr.edu":"University of California, Riverside","ucsb.edu":"University of California, Santa Barbara","ucsc.edu":"University of California, Santa Cruz","ucsd.edu":"University of California, San Diego","ucsf.edu":"University of California, San Francisco","udel.edu":"University of Delaware","ufl.edu":"University of Florida","uga.edu":"University of Georgia","uh.edu":"University of Houston","uhd.edu":"University of Houston–Downtown","uic.edu":"University of Illinois Chicago","uidaho.edu":"University of Idaho","uiowa.edu":"University of Iowa","uky.edu":"University of Kentucky","ulm.edu":"University of Louisiana Monroe","umaine.edu":"University of Maine","umass.edu":"University of Massachusetts Amherst","umassd.edu":"University of Massachusetts Dartmouth","umb.edu":"University of Massachusetts Boston","umbc.edu":"University of Maryland, Baltimore County","umd.edu":"University of Maryland","umich.edu":"University of Michigan","umkc.edu":"University of Missouri–Kansas City","uml.edu":"University of Massachusetts Lowell","umn.edu":"University of Minnesota Twin Cities","umontana.edu":"University of Montana","unc.edu":"University of North Carolina at Chapel Hill","uncg.edu":"University of North Carolina at Greensboro","unco.edu":"University of Northern Colorado","uncw.edu":"University of North Carolina Wilmington","und.edu":"University of North Dakota","unf.edu":"University of North Florida","unh.edu":"University of New Hampshire","uni.edu":"University of Northern Iowa","unk.edu":"University of Nebraska at Kearney","unl.edu":"University of Nebraska–Lincoln","unlv.edu":"University of Nevada, Las Vegas","unm.edu":"The University of New Mexico","uno.edu":"University of New Orleans","unomaha.edu":"University of Nebraska at Omaha","unr.edu":"University of Nevada, Reno","unt.edu":"University of North Texas","uoregon.edu":"University of Oregon","upenn.edu":"University of Pennsylvania","uri.edu":"University of Rhode Island","usc.edu":"University of Southern California","usd.edu":"University of South Dakota","usf.edu":"University of South Florida","usm.edu":"University of Southern Mississippi","usm.maine.edu":"University of Southern Maine","usu.edu":"Utah State University","uta.edu":"The University of Texas at Arlington","utah.edu":"University of Utah","utdallas.edu":"The University of Texas at Dallas","utexas.edu":"The University of Texas at Austin","utk.edu":"University of Tennessee, Knoxville","utoledo.edu":"The University of Toledo","utsa.edu":"The University of Texas at San Antonio","uvm.edu":"University of Vermont","uvu.edu":"Utah Valley University","uw.edu":"University of Washington","uwec.edu":"University of Wisconsin–Eau Claire","uwgb.edu":"University of Wisconsin–Green Bay","uwm.edu":"University of Wisconsin–Milwaukee","uwstout.edu":"University of Wisconsin–Stout","uwyo.edu":"University of Wyoming","vanderbilt.edu":"Vanderbilt University","vcu.edu":"Virginia Commonwealth University","villanova.edu":"Villanova University","virginia.edu":"University of Virginia","vmi.edu":"Virginia Military Institute","vt.edu":"Virginia Tech","washington.edu":"University of Washington","wayne.edu":"Wayne State University","wcu.edu":"Western Carolina University","weber.edu":"Weber State University","wfu.edu":"Wake Forest University","wichita.edu":"Wichita State University","wisc.edu":"University of Wisconsin–Madison","wku.edu":"Western Kentucky University","wm.edu":"William & Mary","wmich.edu":"Western Michigan University","wpi.edu":"Worcester Polytechnic Institute","wright.edu":"Wright State University","wsu.edu":"Washington State University","wustl.edu":"Washington University in St. Louis","wvu.edu":"West Virginia University","wwu.edu":"Western Washington University","yale.edu":"Yale University","york.cuny.edu":"York College (CUNY)","ysu.edu":"Youngstown State University","duq.edu":"Duquesne University","usfca.edu":"University of San Francisco"};

    function SignInForm({ onGoogleSignIn, onEmailSignIn, onEmailSignUp, setView, user, selectedUserId, viewUserProfile, universities, domainIndex }) {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [isSignUp, setIsSignUp] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [selectedUniversityName, setSelectedUniversityName] = useState("");
      const [detectedChoices, setDetectedChoices] = useState([]);
      const knownDomainMap = ALL_UNIVERSITY_DOMAINS; // Use the embedded constant - instant, no loading needed

    // Build candidate universities from email domain
      useEffect(() => {
        const domainRaw = (email.split('@')[1] || '').toLowerCase();
        const domain = normalizeDomain(domainRaw);
        if (!domain) {
          setDetectedChoices([]);
          setSelectedUniversityName("");
          return;
        }
        // knownDomainMap is now initialized with seeds, no need to wait
        // 0) Immediate hard map (prefer exact subdomain match, then normalized root)
        if (knownDomainMap && (knownDomainMap[domainRaw] || knownDomainMap[domain])) {
          const name = knownDomainMap[domainRaw] || knownDomainMap[domain];
          setDetectedChoices([{ name, emailDomain: domain, ...getDefaultCoordinates() }]);
          setSelectedUniversityName(name);
          return;
        }
        // 1) Exact domain match from current universities list
        const candidates = (universities || []).filter(u => {
          const d = (u.emailDomain || '').toLowerCase();
          return domain === d;
        });
        if (candidates.length > 0) {
          setDetectedChoices(candidates);
          setSelectedUniversityName(candidates[0].name);
          return;
        }
        // 2) Try from domain index (Firestore)
        (async () => {
          try {
            const map = (function() {
              if (window.__domainIndex && Object.keys(window.__domainIndex).length) return window.__domainIndex;
              return null;
            })();
            let m = map;
            if (!m) {
              const doc = await loadFromFirestore('app', 'domain_index');
              m = (doc && doc.map) ? doc.map : {};
              window.__domainIndex = m;
            }
            const hit = m && m[domain];
            if (hit) {
              const choice = { name: hit.name, emailDomain: domain, lat: hit.lat, lng: hit.lng, city: hit.city };
              setDetectedChoices([choice]);
              setSelectedUniversityName(choice.name);
              return;
            }
          } catch (error) {
            console.warn('Domain index lookup failed:', error);
          }
          // 3) Fallback: infer from domain string
          const inferred = getUniversityFromDomain(domain);
          setDetectedChoices([{ name: inferred, emailDomain: domain, ...getDefaultCoordinates() }]);
          setSelectedUniversityName(inferred);
        })();
      }, [email, universities, knownDomainMap]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
          if (isSignUp) {
            // Persist the user's chosen university so onAuthStateChanged can use it
            try {
              const chosen = (detectedChoices || []).find(c => c.name === selectedUniversityName) || null;
              window.pendingUniversityChoice = chosen || null;
            } catch (error) {
              console.warn('Failed to set pending university choice:', error);
            }
            await onEmailSignUp(email, password);
          } else {
            await onEmailSignIn(email, password);
          }
        } catch (error) {
          console.error("Form submission error:", error);
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <input
                id="email"
                type="email"
                placeholder="Enter your email"
                value={email}
                onChange={(e) => {
                  const val = e.target.value;
                  setEmail(val);
                  // Synchronous resolve on keystroke for instant mapping
                  const raw = (val.split('@')[1] || '').toLowerCase();
                  if (!raw) return;
                  const norm = normalizeDomain(raw);
                  const name = (window.__KNOWN_DOMAIN_MAP && (window.__KNOWN_DOMAIN_MAP[raw] || window.__KNOWN_DOMAIN_MAP[norm])) ||
                               (typeof KNOWN_DOMAIN_MAP !== 'undefined' && (KNOWN_DOMAIN_MAP[raw] || KNOWN_DOMAIN_MAP[norm]));
                  if (name) {
                    setDetectedChoices([{ name, emailDomain: norm, ...getDefaultCoordinates() }]);
                    setSelectedUniversityName(name);
                  }
                }}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                required
              />
            </div>
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                Password
              </label>
              <input
                id="password"
                type="password"
                placeholder="Enter your password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                required
              />
            </div>
            {isSignUp && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">University (detected from email)</label>
                {detectedChoices.length <= 1 ? (
                  <input
                    type="text"
                    value={selectedUniversityName}
                    onChange={(e) => setSelectedUniversityName(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  />
                ) : (
                  <select
                    value={selectedUniversityName}
                    onChange={(e) => setSelectedUniversityName(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  >
                    {detectedChoices.map(c => (
                      <option key={c.name} value={c.name}>{c.name}</option>
                    ))}
                  </select>
                )}
                <p className="text-xs text-gray-500 mt-1">We matched your email domain to your university. Edit if needed.</p>
              </div>
            )}
            <button
              type="submit"
              className="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-colors disabled:opacity-50"
              disabled={isLoading}
            >
              {isLoading ? "Loading..." : (isSignUp ? "Sign Up" : "Sign In")}
            </button>
            <button
              type="button"
              onClick={() => setIsSignUp(!isSignUp)}
              className="w-full text-orange-500 hover:text-orange-600 transition-colors"
            >
              {isSignUp ? "Already have an account? Sign In" : "Need an account? Sign Up"}
            </button>
          </form>
          <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300"></div>
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
          </div>
          <button
            onClick={onGoogleSignIn}
            className="w-full bg-white border border-gray-300 py-2 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors"
          >
            <img 
              src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" 
              alt="Google" 
              className="w-5 h-5 mr-2"
            />
            Sign in with Google
          </button>
        </div>
      );
    }

    function ProfileForm({ onSave, initialProfile = {} }) {
      // Handle case where initialProfile might be null
      const safeProfile = initialProfile || {};
      const [firstName, setFirstName] = useState(safeProfile.firstName || "");
      const [lastName, setLastName] = useState(safeProfile.lastName || "");
      const [bio, setBio] = useState(safeProfile.bio || "");
      const [idea, setIdea] = useState(safeProfile.idea || "");
      const [lookingFor, setLookingFor] = useState(safeProfile.lookingFor || "");
      const [picture, setPicture] = useState(safeProfile.picture || null);
      const [graduationYear, setGraduationYear] = useState(safeProfile.graduationYear || "");
      const [projectLink, setProjectLink] = useState(safeProfile.projectLink || "");
      const [hasIdea, setHasIdea] = useState(safeProfile.hasIdea || "");
      const [isWorkingOnIdea, setIsWorkingOnIdea] = useState(safeProfile.isWorkingOnIdea || "");
      const [social, setSocial] = useState({
        twitter: safeProfile.social?.twitter || "",
        linkedin: safeProfile.social?.linkedin || "",
        website: safeProfile.social?.website || "",
        github: safeProfile.social?.github || ""
      });
      const [error, setError] = useState("");

      const handleSave = () => {
        if (!firstName.trim()) {
          setError("First Name is required.");
          return;
        } else {
          setError("");
        }
        onSave({
          firstName,
          lastName,
          bio,
          idea,
          lookingFor,
          picture,
          graduationYear,
          projectLink,
          hasIdea,
          isWorkingOnIdea,
          social
        });
      };

      // Generate graduation year options
      const currentYear = new Date().getFullYear();
      const graduationYears = Array.from({ length: 6 }, (_, i) => currentYear + i);

      return (
        <div className="space-y-0">
          <div className="flex items-start space-x-6">
            <div className="flex-shrink-0">
              <div className="relative">
                {picture ? (
                  <img 
                    src={picture} 
                    alt="Profile" 
                    className="w-32 h-32 object-cover rounded-lg shadow-md"
                  />
                ) : (
                  <div className="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center">
                    <svg className="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                )}
                <label className="absolute bottom-0 right-0 bg-orange-500 text-white p-2 rounded-full cursor-pointer hover:bg-orange-600 transition-colors">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
            <input
              type="file"
              accept="image/*"
              onChange={(e) => setPicture(e.target.files[0] ? URL.createObjectURL(e.target.files[0]) : null)}
                    className="hidden"
                  />
                </label>
              </div>
            </div>
            <div className="flex-grow space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                  <input
                    type="text"
                    placeholder="Enter your first name"
                    value={firstName}
                    onChange={(e) => setFirstName(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                  <input
                    type="text"
                    placeholder="Enter your last name"
                    value={lastName}
                    onChange={(e) => setLastName(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
            />
          </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
          <textarea
                  placeholder="Tell us about yourself..."
            value={bio}
            onChange={(e) => setBio(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                  rows="3"
                />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">I have an Idea</label>
                  <select
                    value={hasIdea}
                    onChange={(e) => setHasIdea(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                  >
                    <option value="">Select</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">I'm working on an idea currently</label>
                  <select
                    value={isWorkingOnIdea}
                    onChange={(e) => setIsWorkingOnIdea(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                  >
                    <option value="">Select</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-gray-50 p-4 rounded-lg">
            <label className="block text-sm font-medium text-gray-700 mb-1">Your Idea</label>
          <textarea
              placeholder="Describe your startup idea..."
            value={idea}
            onChange={(e) => setIdea(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
              rows="4"
            />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Graduation Year</label>
              <select
                value={graduationYear}
                onChange={(e) => setGraduationYear(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
              >
                <option value="">Select Year</option>
                {graduationYears.map(year => (
                  <option key={year} value={year}>{year}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Project Link</label>
              <input
                type="url"
                placeholder="https://your-project.com"
                value={projectLink}
                onChange={(e) => setProjectLink(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">What You're Looking For</label>
          <textarea
              placeholder="Describe what kind of collaborators you're looking for..."
            value={lookingFor}
            onChange={(e) => setLookingFor(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
              rows="3"
            />
          </div>

          <div className="space-y-4">
            <h3 className="text-lg font-medium text-gray-900">Social Links</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Twitter</label>
                <input
                  type="url"
                  placeholder="https://twitter.com/username"
                  value={social.twitter}
                  onChange={(e) => setSocial({...social, twitter: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                <input
                  type="url"
                  placeholder="https://linkedin.com/in/username"
                  value={social.linkedin}
                  onChange={(e) => setSocial({...social, linkedin: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Personal Website</label>
                <input
                  type="url"
                  placeholder="https://yourwebsite.com"
                  value={social.website}
                  onChange={(e) => setSocial({...social, website: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">GitHub</label>
                <input
                  type="url"
                  placeholder="https://github.com/username"
                  value={social.github}
                  onChange={(e) => setSocial({...social, github: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                />
              </div>
            </div>
          </div>

          {error && (
            <div className="text-red-500 text-xs font-mono mb-2">{error}</div>
          )}

          <button
            onClick={handleSave}
            className="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition-colors font-mono"
          >
            {safeProfile.bio ? "Update Profile" : "Save Profile"}
          </button>
        </div>
      );
    }

    function ProfileView({ user, users, selectedUserId, onEdit }) {
      // Determine which user's profile to display
      const profileUser = selectedUserId ? users.find(u => u.id === selectedUserId) : user;

      if (!profileUser) {
        return (
          <div className="text-center py-4">
            <p className="text-gray-500 font-mono text-sm">Profile not found.</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          <div className="flex items-start space-x-6">
            <div className="flex-shrink-0">
          <img
                src={profileUser.profile?.picture || getRandomAvatar()}
            alt="Profile"
                className="w-32 h-32 object-cover rounded-lg shadow-md"
              />
            </div>
            <div className="flex-grow">
              <h2 className="text-2xl font-bold text-gray-900 mb-2 font-mono">
                {profileUser.profile?.firstName && profileUser.profile?.lastName 
                  ? `${profileUser.profile.firstName} ${profileUser.profile.lastName}`
                  : profileUser.email}
              </h2>
              {!profileUser.profile && (
                <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <p className="text-yellow-800 text-sm font-mono">Profile not set up yet. Click "Edit Profile" to create your profile.</p>
                </div>
              )}
              <div className="flex items-center space-x-4 text-sm text-gray-600 mb-4">
                <span>{profileUser.university}</span>
                {profileUser.profile?.graduationYear && (
                  <>
                    <span>•</span>
                    <span>Class of {profileUser.profile.graduationYear}</span>
                    {profileUser?.email && (
                      <>
                        <span className="mx-2">•</span>
                        <a
                          href={`mailto:${profileUser.email}`}
                          className="text-orange-500 hover:text-orange-600 font-mono text-sm font-medium"
                        >
                          email
                        </a>
                      </>
                    )}
                  </>
                )}
              </div>
              {profileUser.profile?.projectLink && (
                <a 
                  href={profileUser.profile.projectLink} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="inline-block mb-4 text-orange-500 hover:text-orange-600 font-mono text-sm"
                >
                  View Project →
                </a>
              )}
              <div className="flex space-x-4">
                {profileUser.profile?.social?.twitter && (
                  <a href={profileUser.profile.social.twitter} target="_blank" rel="noopener noreferrer" className="text-gray-600 hover:text-orange-500">
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                    </svg>
                  </a>
                )}
                {profileUser.profile?.social?.linkedin && (
                  <a href={profileUser.profile.social.linkedin} target="_blank" rel="noopener noreferrer" className="text-gray-600 hover:text-orange-500">
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                  </a>
                )}
                {profileUser.profile?.social?.github && (
                  <a href={profileUser.profile.social.github} target="_blank" rel="noopener noreferrer" className="text-gray-600 hover:text-orange-500">
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
                    </svg>
                  </a>
                )}
                {profileUser.profile?.social?.website && (
                  <a href={profileUser.profile.social.website} target="_blank" rel="noopener noreferrer" className="text-gray-600 hover:text-orange-500">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                  </a>
                )}
              </div>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-2 font-mono">Bio</h3>
              <p className="text-gray-600 font-mono text-sm">{profileUser.profile?.bio || "No bio provided."}</p>
            </div>

            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-2 font-mono">Idea</h3>
              <p className="text-gray-600 font-mono text-sm">{profileUser.profile?.idea || "No idea provided."}</p>
            </div>

            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-2 font-mono">Looking For</h3>
              <p className="text-gray-600 font-mono text-sm">{profileUser.profile?.lookingFor || "Not specified."}</p>
            </div>
          </div>

          {user && profileUser.id === user.id && (
             <button
               onClick={() => onEdit()}
               className="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition-colors font-mono"
             >
               {profileUser.profile ? "Edit Profile" : "Set Up Profile"}
             </button>
          )}
        </div>
      );
    }

    function PostBoard({ posts, user, onEditPost, onDeletePost, onAddComment, users, setView, selectedUserId, viewUserProfile, feedMode, setFeedMode, selectedCity, setSelectedCity, universities, universityFilter, clearUniversityFilter, distanceFilter, setDistanceFilter, promptSignIn }) {
      const [filterCategory, setFilterCategory] = useState('all');
      const [sortMode, setSortMode] = useState('recent'); // 'recent' | 'comments'
      const availableCities = React.useMemo(() => {
        const set = new Set();
        universities.forEach(u => { if (u.city) set.add(u.city); });
        // Ensure Pittsburgh exists
        if (!set.has('Pittsburgh')) set.add('Pittsburgh');
        // Prefer ordered list
        const ordered = ['Boston', 'San Francisco', 'Pittsburgh', 'New York City', 'Chicago', 'Seattle', 'Austin'];
        const rest = Array.from(set).filter(c => !ordered.includes(c)).sort();
        return [...ordered.filter(c => set.has(c)), ...rest];
      }, [universities]);

      return (
        <div className="max-w-4xl mx-auto">
          <div id="post-list-start"></div>
          <div className="mt-0 mb-3">
            <h2 className="text-2xl leading-tight font-bold text-gray-900 font-mono">
              {feedMode === 'global' ? 'Global Startup Projects' : (feedMode === 'city' ? `${selectedCity} Startup Projects` : 'Startup Projects Near You')}
            </h2>
          </div>
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center space-x-4">
              {!universityFilter && (
                <>
                  <button
                    onClick={() => { if (!user) { promptSignIn && promptSignIn('Sign in to use Local view near you.'); return; } setFeedMode('local'); }}
                    className={`px-3 py-1 rounded text-sm font-medium ${feedMode === 'local' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                  >
                    Local
                  </button>
                  <button
                    onClick={() => setFeedMode('city')}
                    className={`px-3 py-1 rounded text-sm font-medium ${feedMode === 'city' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                  >
                    Cities
                  </button>
                  <button
                    onClick={() => setFeedMode('global')}
                    className={`px-3 py-1 rounded text-sm font-medium ${feedMode === 'global' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                  >
                    Global
                  </button>
                  {feedMode === 'local' && user && (
                    <div className="flex items-center space-x-2 ml-4">
                      <span className="text-gray-600 font-mono text-sm">Distance:</span>
                      <select
                        value={distanceFilter}
                        onChange={(e) => setDistanceFilter(parseInt(e.target.value))}
                        className="px-2 py-1 border border-gray-300 rounded text-sm font-mono bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      >
                        <option value={50}>50 miles</option>
                        <option value={100}>100 miles</option>
                        <option value={200}>200 miles</option>
                      </select>
                    </div>
                  )}
                  {feedMode === 'city' && (
                    <div className="flex items-center space-x-2 ml-4">
                      <span className="text-gray-600 font-mono text-sm">City:</span>
                      <select
                        value={selectedCity}
                        onChange={(e) => { setSelectedCity(e.target.value); }}
                        className="px-2 py-1 border border-gray-300 rounded text-sm font-mono bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      >
                        {availableCities.map(city => (
                          <option key={city} value={city}>{city}</option>
                        ))}
                      </select>
                    </div>
                  )}
                </>
              )}
              {universityFilter && (
                <div className="flex items-center space-x-2 bg-gradient-to-r from-orange-400 to-orange-500 shadow border border-orange-500 rounded-full px-3 py-1">
                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                  <span className="text-white font-mono text-sm font-semibold truncate max-w-[330px]">
                    {universityFilter}
                  </span>
                  <button
                    onClick={clearUniversityFilter}
                    className="ml-1 bg-white text-orange-600 hover:bg-orange-100 hover:text-orange-800 rounded-full w-5 h-5 flex items-center justify-center text-base font-bold shadow transition"
                    aria-label="Clear filter"
                    style={{ lineHeight: 1 }}
                  >
                    ×
                  </button>
                </div>
              )}
            </div>
            <div className="flex space-x-2">
              <select
                value={filterCategory || 'all'}
                onChange={(e) => setFilterCategory(e.target.value)}
                className="px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
              >
                <option value="all">All Categories</option>
                <option value="Tech">Tech</option>
                <option value="Sustainability">Sustainability</option>
                <option value="Social Impact">Social Impact</option>
                <option value="Health">Health</option>
                <option value="Education">Education</option>
                <option value="Finance">Finance</option>
              </select>
              <select
                value={sortMode}
                onChange={(e) => setSortMode(e.target.value)}
                className="px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
              >
                <option value="recent">Most Recent</option>
                <option value="comments">Most Comments</option>
              </select>
            </div>
          </div>
          {(() => {
            // Apply category filter
            let list = posts;
            if (filterCategory !== 'all') {
              list = list.filter(p => p.category === filterCategory);
            }
            // Apply sorting
            const sorted = [...list].sort((a, b) => {
              if (sortMode === 'comments') {
                const ac = (a.comments?.length || 0);
                const bc = (b.comments?.length || 0);
                return bc - ac;
              }
              // recent (by createdAt ISO date string)
              const ad = new Date(a.createdAt || 0).getTime();
              const bd = new Date(b.createdAt || 0).getTime();
              return bd - ad;
            });
            return sorted;
          })().length === 0 ? (
            <div className="text-center py-4">
              <p className="text-gray-500 font-mono text-sm">No posts available.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {(() => {
                let list = posts;
                if (filterCategory !== 'all') {
                  list = list.filter(p => p.category === filterCategory);
                }
                const sorted = [...list].sort((a, b) => {
                  if (sortMode === 'comments') {
                    const ac = (a.comments?.length || 0);
                    const bc = (b.comments?.length || 0);
                    return bc - ac;
                  }
                  const ad = new Date(a.createdAt || 0).getTime();
                  const bd = new Date(b.createdAt || 0).getTime();
                  return bd - ad;
                });
                return sorted;
              })().map(post => {
                const postUser = users.find(u => u.id === post.userId);
                return (
                  <div
                    key={post.id}
                    className="bg-white rounded-lg shadow-sm overflow-hidden transition-shadow duration-300 p-3 hover:bg-orange-50 hover:shadow-lg cursor-pointer"
                    style={{ transition: 'background 0.2s' }}
                    onClick={() => { if (!user) { promptSignIn && promptSignIn('Sign in to view Project Details.'); return; } setView(`post-${post.id}`); }}
                  >
                    {/* Title */}
                    <h3 className="text-base font-bold text-gray-900 mb-1 font-mono line-clamp-1">
                      {post.title}
                    </h3>
                    {/* Summary */}
                    <p className="text-gray-700 mb-2 font-mono text-xs leading-snug line-clamp-2">{post.summary}</p>
                    {/* Looking For */}
                    <div className="bg-orange-100 border border-orange-200 rounded p-1 mb-2 mt-0">
                      <div className="flex items-baseline gap-1">
                        <span className="text-xs font-semibold text-orange-700 font-mono whitespace-nowrap">Looking for:</span>
                        <span className="flex-1 min-w-0 text-gray-800 font-mono text-xs leading-snug truncate">{post.lookingFor}</span>
                      </div>
                    </div>
                    {/* Bottom Row: Meta and Actions */}
                    <div className="flex justify-between items-center mt-1">
                      {/* Meta info */}
                      <div className="flex items-center space-x-2 text-[11px] text-gray-500 font-mono">
                        <span className="bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full text-[10px] font-medium">{post.category}</span>
                        <span>{post.university}</span>
                        <span>•</span>
                        <span>{post.createdAt}</span>
                        {postUser && postUser.profile && (
                          <>
                            <span className="ml-1 text-gray-600">by</span>
                            <button
                              className="text-orange-600 hover:underline font-mono text-xs font-semibold ml-1"
                              onClick={e => { e.stopPropagation(); if (!user) { promptSignIn && promptSignIn('Sign in to view member profiles.'); return; } viewUserProfile && viewUserProfile(postUser.id); }}
                            >
                              {postUser.profile.firstName} {postUser.profile.lastName}
                            </button>
                          </>
                        )}
                      </div>
                      {/* Actions */}
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={e => { e.stopPropagation(); if (!user) { promptSignIn && promptSignIn('Sign in to view Project Details.'); return; } setView(`post-${post.id}`); }}
                          className="text-orange-500 hover:text-orange-600 font-mono text-xs font-semibold px-1"
                        >
                          Project Details
                        </button>
                        {post.projectLink && (
                          <a
                            href={post.projectLink}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-orange-500 hover:text-orange-600 font-mono text-xs font-semibold px-1"
                            onClick={e => e.stopPropagation()}
                          >
                            Project Site →
                          </a>
                        )}
                        {user && user.id === post.userId && (
                          <>
                            <button
                              onClick={e => { e.stopPropagation(); onDeletePost(post.id); }}
                              className="text-red-500 hover:text-red-600 font-mono text-xs font-semibold px-1"
                            >
                              Delete
                            </button>
                            <button
                              onClick={e => { e.stopPropagation(); setView(`edit-${post.id}`); }}
                              className="text-orange-500 hover:text-orange-600 font-mono text-xs font-semibold px-1"
                            >
                              Edit
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    function PostView({ post, user, users, onEdit, onDelete, onAddComment, setView, selectedUserId, viewUserProfile }) {
      // Find the user who created this post
      const postUser = users.find(u => u.id === post?.userId);

      return (
        <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
          <div className="p-6">
            {/* Back Button */}
            <button
              onClick={() => setView && setView("posts")}
              className="mt-0 mb-3 text-orange-400 hover:text-orange-500 font-mono text-xs font-medium px-2 py-0.5 rounded border border-orange-100 bg-orange-50 hover:bg-orange-100 transition-colors shadow-none"
              style={{ boxShadow: 'none' }}
            >
              ← Back to Posts
            </button>
            <div className="flex justify-between items-start mb-4">
              <div>
                <h2 className="text-xl font-bold text-gray-800 mb-2 font-mono">{post.title}</h2>
                <div className="flex items-center text-sm text-gray-500 font-mono">
                  <span className="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium mr-2">
                    {post.category}
                  </span>
                  <span>{post.university}</span>
                  <span className="mx-2">•</span>
                  <span className="text-sm">{post.createdAt}</span>
                  {postUser && postUser.profile && (
                    <>
                      <span className="ml-1 text-gray-600 text-sm">by</span>
                      <button
                        className="text-orange-600 hover:underline font-mono text-sm font-semibold ml-1 align-baseline"
                        onClick={e => { e.stopPropagation(); viewUserProfile && viewUserProfile(postUser.id); }}
                      >
                        {postUser.profile.firstName} {postUser.profile.lastName}
                      </button>
                    </>
                  )}
                </div>
              </div>
              {user && user.id === post.userId && (
                <div className="flex space-x-2">
                  <button
                    onClick={onEdit}
                    className="text-orange-500 hover:text-orange-600 text-sm font-mono"
                  >
                    Edit
                  </button>
                  <button
                    onClick={onDelete}
                    className="text-red-500 hover:text-red-600 text-sm font-mono"
                  >
                    Delete
                  </button>
                </div>
              )}
            </div>
            <div className="prose max-w-none mb-5">
              <p className="text-gray-700 font-mono text-sm leading-relaxed">{post.summary}</p>
            </div>
            <div className="bg-orange-50 p-3 rounded-lg mb-5">
              <div className="flex items-baseline gap-2">
                <h4 className="font-semibold text-orange-700 font-mono text-sm whitespace-nowrap m-0">Looking for:</h4>
                <p className="text-gray-700 font-mono text-sm leading-relaxed m-0 truncate flex-1 min-w-0">{post.lookingFor}</p>
              </div>
            </div>
            {/* Project Site Link */}
            {post.projectLink && (
              <a
                href={post.projectLink}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-block mb-6 text-orange-500 hover:text-orange-600 font-mono text-sm font-semibold"
              >
                Project Site →
              </a>
            )}
            <div className="border-t pt-5">
              <h4 className="text-lg font-semibold text-gray-800 mb-4 font-mono">Comments</h4>
              {post.comments.length === 0 ? (
                <p className="text-gray-500 font-mono text-sm">No comments yet.</p>
              ) : (
                <div className="space-y-4">
                  {post.comments.map(comment => {
                    const commentUser = users.find(u => u.id === comment.userId);
                    const fullName = commentUser?.profile?.firstName && commentUser?.profile?.lastName
                      ? `${commentUser.profile.firstName} ${commentUser.profile.lastName}`
                      : commentUser?.email || "Unknown";
                    return (
                      <div key={comment.id} className="bg-gray-50 p-2 rounded-lg">
                        <div className="flex items-center mb-1">
                          <button
                            className="flex items-center group focus:outline-none"
                            style={{ background: 'none', border: 'none', padding: 0, margin: 0, cursor: 'pointer' }}
                            onClick={() => viewUserProfile && viewUserProfile(commentUser.id)}
                          >
                            <img
                              src={commentUser?.profile?.picture || getRandomAvatar()}
                              alt="User"
                              className="w-5 h-5 rounded-full mr-1.5 group-hover:ring-2 group-hover:ring-orange-300"
                            />
                            <span className="font-medium text-sm group-hover:underline font-mono">
                              {fullName}
                            </span>
                          </button>
                          <p className="text-xs text-gray-500 ml-2 font-mono">{comment.createdAt}</p>
                        </div>
                        <p className="text-gray-600 font-mono text-sm leading-snug">{comment.text}</p>
                      </div>
                    );
                  })}
                </div>
              )}
              <CommentForm postId={post.id} onAddComment={onAddComment} />
            </div>
          </div>
        </div>
      );
    }

    function CommentForm({ postId, onAddComment }) {
      const [comment, setComment] = useState("");

      return (
        <div className="mt-3">
          <textarea
            placeholder="Add a comment..."
            value={comment}
            onChange={(e) => setComment(e.target.value)}
            className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
            rows="2"
          />
          <button
            onClick={() => {
              if (comment.trim()) {
                onAddComment(postId, comment);
                setComment("");
              }
            }}
            className="mt-2 bg-orange-500 text-white px-3 py-1 rounded-lg hover:bg-orange-600 transition-colors duration-200 font-mono text-xs"
          >
            Post Comment
          </button>
        </div>
      );
    }

    function CreatePostForm({ onCreate, initialPost = {} }) {
      const [title, setTitle] = useState(initialPost.title || "");
      const [summary, setSummary] = useState(initialPost.summary || "");
      const [lookingFor, setLookingFor] = useState(initialPost.lookingFor || "");
      const [category, setCategory] = useState(initialPost.category || "Tech");
      const [projectLink, setProjectLink] = useState(initialPost.projectLink || "");
      const [stage, setStage] = useState(initialPost.stage || "idea");

      return (
        <div className="space-y-4">
          <div className="bg-white rounded-lg p-4 shadow-sm">
            <h3 className="text-lg font-medium text-gray-900 mb-3 font-mono">Basic Information</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
          <input
            type="text"
                  placeholder="Give your post a clear, concise title"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select
            value={category}
            onChange={(e) => setCategory(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
          >
            <option value="Tech">Tech</option>
            <option value="Sustainability">Sustainability</option>
            <option value="Social Impact">Social Impact</option>
            <option value="Health">Health</option>
                    <option value="Education">Education</option>
                    <option value="Finance">Finance</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Project Stage</label>
                  <select
                    value={stage}
                    onChange={(e) => setStage(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                  >
                    <option value="idea">Just an Idea</option>
                    <option value="planning">Planning Phase</option>
                    <option value="development">In Development</option>
                    <option value="launched">Launched</option>
          </select>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg p-4 shadow-sm">
            <h3 className="text-lg font-medium text-gray-900 mb-3 font-mono">Project Details</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Project Link (if any)</label>
                <input
                  type="url"
                  placeholder="https://your-project.com"
                  value={projectLink}
                  onChange={(e) => setProjectLink(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Summary</label>
                <textarea
                  placeholder="Describe your startup idea in detail..."
                  value={summary}
                  onChange={(e) => setSummary(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                  rows="6"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">What You're Looking For</label>
                <textarea
                  placeholder="Describe what kind of collaborators you're looking for..."
                  value={lookingFor}
                  onChange={(e) => setLookingFor(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                  rows="4"
                />
              </div>
            </div>
          </div>

          <button
            onClick={() => onCreate({ 
              title, 
              summary, 
              lookingFor, 
              category,
              projectLink,
              stage,
              createdAt: new Date().toISOString().split("T")[0]
            })}
            className="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition-colors font-mono"
          >
            {initialPost.title ? "Update Post" : "Create Post"}
          </button>
        </div>
      );
    }

    function MapView({ user, posts, users, onUniversityFilter, center = null, showUserMarker = true, title = null, zoom = 12 }) {
      const mapRef = React.useRef(null);
      const mapInstanceRef = React.useRef(null);
      const skipNextRecenterRef = React.useRef(false);
      const markerLayerRef = React.useRef(null);

      React.useEffect(() => {
        if (!mapRef.current || mapInstanceRef.current) return;

        // Initialize map centered either on provided center or user's location
        const initialCenter = center ? [center.lat, center.lng] : [user.lat, user.lng];
        mapInstanceRef.current = L.map(mapRef.current).setView(initialCenter, zoom);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(mapInstanceRef.current);

        // Add user marker (optional)
        if (showUserMarker && user.lat && user.lng) {
          L.marker([user.lat, user.lng])
            .addTo(mapInstanceRef.current)
            .bindPopup(`<b>You</b><br>${user.university}`)
            .openPopup();
        }
        // Create a dedicated layer for university markers
        markerLayerRef.current = L.layerGroup().addTo(mapInstanceRef.current);

        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.remove();
            mapInstanceRef.current = null;
          }
        };
      }, [user, onUniversityFilter, center, showUserMarker]);

      // Update markers whenever posts/users change without re-initializing the map
      React.useEffect(() => {
        const map = mapInstanceRef.current;
        const layer = markerLayerRef.current;
        if (!map || !layer) return;
        layer.clearLayers();

        // Group posts by university
        const universityPosts = {};
        posts.forEach(post => {
          const postUser = users.find(u => u.id === post.userId);
          if (postUser && postUser.lat && postUser.lng) {
            if (!universityPosts[postUser.university]) {
              universityPosts[postUser.university] = {
                lat: postUser.lat,
                lng: postUser.lng,
                posts: [],
                user: postUser
              };
            }
            universityPosts[postUser.university].posts.push(post);
          }
        });

        // Provide a global helper for popup button to filter and scroll
        window.filterByUniversity = (uniName) => {
          onUniversityFilter(uniName);
          const el = document.getElementById('post-list-start');
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        Object.entries(universityPosts).forEach(([universityName, data]) => {
          const count = data.posts.length;
          const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
              <div style="
                background: #f97316;
                color: white;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 12px;
                border: 2px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
              ">
                ${count}
              </div>
            `,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          });

          const marker = L.marker([data.lat, data.lng], { icon: customIcon })
            .addTo(layer)
            .bindPopup(`
              <div style="min-width: 200px;">
                <b>${universityName}</b><br>
                <small>${count} project${count > 1 ? 's' : ''}</small><br>
                <button onclick="window.filterByUniversity('${universityName}')" 
                        style="
                          background: #f97316; 
                          color: white; 
                          border: none; 
                          padding: 4px 8px; 
                          border-radius: 4px; 
                          margin-top: 8px; 
                          cursor: pointer;
                          font-size: 12px;
                        ">
                  View Projects
                </button>
              </div>
            `);

          marker.on('click', () => {
            const current = map.getZoom();
            const base = Number.isFinite(current) ? current : (Number.isFinite(zoom) ? zoom : 12);
            const targetZoom = Math.min(base + 2, 18);
            skipNextRecenterRef.current = true;
            map.flyTo([data.lat, data.lng], targetZoom, { animate: true, duration: 0.8 });
          });
        });
      }, [posts, users, onUniversityFilter]);

      // Recenter and update zoom whenever `center` or `zoom` changes
      React.useEffect(() => {
        if (!mapInstanceRef.current) return;
        const nextCenter = center ? [center.lat, center.lng] : (user?.lat && user?.lng ? [user.lat, user.lng] : null);
        if (nextCenter) {
          if (skipNextRecenterRef.current) {
            // Skip one recenter immediately after an explicit click-zoom
            skipNextRecenterRef.current = false;
            return;
          }
          mapInstanceRef.current.setView(nextCenter, zoom);
        }
      }, [center, zoom]);

      return (
        <div className="mb-4">
          <h3 className="text-lg font-medium text-gray-900 mb-3 font-mono">{title || 'Startup Projects Near You'}</h3>
          <div ref={mapRef} style={{ height: '500px', width: '100%' }} className="rounded-lg border"></div>
        </div>
      );
    }

    function AboutPage({ setView, user }) {
      return (
        <div className="space-y-6">
          <div className="mb-3">
            <h1 className="text-2xl font-bold text-gray-800 font-mono">About UniStartupBoard</h1>
            <p className="text-orange-500 font-mono text-sm mt-1">Enabling the next generation of startups</p>
            <div className="border-b border-gray-200 mt-2"></div>
          </div>

          <h2 className="text-xl font-semibold text-gray-800 font-mono mt-6 mb-0 border-b border-gray-200 pb-1">The problem</h2>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-0.5">
            University startup ecosystems are noisy and fragmented. Great ideas stall because:
          </p>
          <ul className="list-disc pl-6 text-gray-700 font-mono text-sm leading-normal space-y-1">
            <li>the <span className="font-semibold">one critical teammate</span> (designer, ML person, biz dev lead) never crosses paths with the team that needs them,</li>
            <li>resources live in scattered group chats, newsletters, and dead forums, and</li>
            <li>students don’t see what’s being built <span className="font-semibold">outside</span> their immediate friend circle or campus.</li>
          </ul>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-0.5">
            The result? Promising projects fail to reach escape velocity—not for lack of talent or ambition, but for lack of the <span className="font-semibold">right connection at the right time</span>.
          </p>

          <h2 className="text-xl font-semibold text-gray-800 font-mono mt-6 mb-0 border-b border-gray-200 pb-1">Our mission</h2>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-0.5">
            Make it effortless for students to find each other and turn innovative ideas into real products—together.
          </p>

          <h2 className="text-xl font-semibold text-gray-800 font-mono mt-6 mb-0 border-b border-gray-200 pb-1">What UniStartupBoard is</h2>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-0.5">
            UniStartupBoard is a matchmaking and discovery platform for student builders. It’s where you:
          </p>
          <ul className="list-disc pl-6 text-gray-700 font-mono text-sm leading-normal space-y-1">
            <li><span className="font-semibold">Find co-founders and contributors</span> who complement your skills,</li>
            <li><span className="font-semibold">Showcase</span> what you’re building and what you need next,</li>
            <li><span className="font-semibold">Discover</span> projects across your campus—and nearby—that align with your interests.</li>
          </ul>

          <h2 className="text-xl font-semibold text-gray-800 font-mono mt-6 mb-0 border-b border-gray-200 pb-1">How it works</h2>
          <ol className="list-decimal pl-6 text-gray-700 font-mono text-sm leading-normal space-y-1 mt-0.5">
            <li><button type="button" className="font-semibold text-orange-600 hover:text-orange-700 underline" onClick={() => setView(user ? 'profile' : 'signin')}>Create a profile</button> – highlight skills, interests, stack, and availability.</li>
            <li><span className="font-semibold">Post a project or join one</span> – clearly list the problem, stage, and what you need (e.g., “Backend help 5–8 hrs/week”).</li>
            <li><span className="font-semibold">Get smart matches</span> – our matching surfaces complementary skills, similar interests, and overlapping availability.</li>
            <li><span className="font-semibold">Connect</span> – warm intros, message, and set up a first call—right inside the platform.</li>
          </ol>

          <h2 className="text-xl font-semibold text-gray-800 font-mono mt-6 mb-0 border-b border-gray-200 pb-1">Get started</h2>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-0.5">
            Create your profile, post your project (or join one), and meet the people who make your idea inevitable.
          </p>

          <h2 className="text-xl font-semibold text-gray-800 font-mono mt-6 mb-0 border-b border-gray-200 pb-1">Contact</h2>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-0.5">
            If you have any comments or feedback, please reach out to
            {' '}<a href="mailto:matt@alias.co" className="text-orange-600 hover:text-orange-700 underline">matt@alias.co</a>.
          </p>
          <p className="text-gray-700 font-mono text-sm leading-normal mt-1">
            This entire project was vibecoded and an opportunity to test out new systems &amp; capabilities. I learned a lot building this, and this project aims to tackle what I experienced to be a very real problem.
          </p>
        </div>
      );
    }

    // Handle navigation for edit post and post view
    function handleHashChange() {
      const hash = window.location.hash.replace("#", "");
      if (hash.startsWith("edit-") || hash.startsWith("post-")) {
        document.dispatchEvent(new Event("viewChange"));
      }
    }

    window.addEventListener("hashchange", handleHashChange);
    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>